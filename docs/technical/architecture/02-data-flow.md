# ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğµ

**Ğ”Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ:** 2025-12-14
**Ğ”Ğ»Ñ ĞºĞ¾Ğ³Ğ¾:** Ğ”Ğ»Ñ Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ, ĞºĞ°Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ

---

## ğŸ¯ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ğ¸Ğ´ĞµÑ

Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñƒ, ĞºĞ°Ğº ÑÑ‹Ñ€ÑŒÑ‘ Ğ½Ğ° Ñ„Ğ°Ğ±Ñ€Ğ¸ĞºĞµ:
- **Ğ’Ñ…Ğ¾Ğ´:** Ğ¥Ğ°Ğ¾Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ (PDF, ÑĞºĞ°Ğ½Ñ‹, Word)
- **ĞŸÑ€Ğ¾Ñ†ĞµÑÑ:** ĞĞ½Ğ°Ğ»Ğ¸Ğ·, ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ
- **Ğ’Ñ‹Ñ…Ğ¾Ğ´:** Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚ Ğ˜Ğ” (Ğ¾Ğ´Ğ¸Ğ½ PDF Ñ„Ğ°Ğ¹Ğ» ÑĞ¾ Ğ²ÑĞµĞ¼)

---

## ğŸ“Š ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### Ğ­Ñ‚Ğ°Ğ¿ 1: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°

**Ğ’Ñ…Ğ¾Ğ´:**
```
Ğ¤Ğ°Ğ¹Ğ» Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:
- ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: "Ğ Ğ°Ğ·Ğ´ĞµĞ» ĞĞ’.pdf"
- Ğ Ğ°Ğ·Ğ¼ĞµÑ€: 15 MB
- Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: PDF
- Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ: ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ (Ñ‚ĞµĞºÑÑ‚ + Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ + Ñ‡ĞµÑ€Ñ‚ĞµĞ¶Ğ¸)
```

**ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°:**
```javascript
// Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ (React)
const file = event.target.files[0];

// Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
if (file.size > 50 * 1024 * 1024) {
  alert("Ğ¤Ğ°Ğ¹Ğ» ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ (Ğ¼Ğ°ĞºÑ 50MB)");
  return;
}

if (!file.type.includes('pdf')) {
  alert("Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ PDF Ñ„Ğ°Ğ¹Ğ»Ñ‹");
  return;
}

// ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ½Ğ° backend
const formData = new FormData();
formData.append('file', file);
formData.append('project_id', 123);
formData.append('doc_type', 'Ğ Ğ”');

fetch('/api/v1/documents/upload', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`
  },
  body: formData
});
```

**Ğ’Ñ‹Ñ…Ğ¾Ğ´:**
```json
{
  "document_id": 456,
  "filename": "Ğ Ğ°Ğ·Ğ´ĞµĞ» ĞĞ’.pdf",
  "status": "uploaded",
  "task_id": "abc-123-xyz"
}
```

**Ğ§Ñ‚Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² Ğ‘Ğ”:**
```sql
INSERT INTO documents (
  project_id,
  filename,
  file_path,
  doc_type,
  mime_type,
  file_size,
  uploaded_by
) VALUES (
  123,
  'Ğ Ğ°Ğ·Ğ´ĞµĞ» ĞĞ’.pdf',
  'projects/123/docs/rd_456.pdf',
  'Ğ Ğ”',
  'application/pdf',
  15728640,
  1
);
```

---

### Ğ­Ñ‚Ğ°Ğ¿ 2: Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ° (ĞµÑĞ»Ğ¸ PDF)

**Ğ’Ñ…Ğ¾Ğ´:**
```
Ğ¤Ğ°Ğ¹Ğ»: projects/123/docs/rd_456.pdf
```

**ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° (Python):**
```python
import PyMuPDF  # fitz

# ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ PDF
doc = fitz.open("projects/123/docs/rd_456.pdf")

# Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ÑĞ¾ Ğ²ÑĞµÑ… ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†
full_text = ""
for page_num in range(len(doc)):
    page = doc[page_num]
    full_text += page.get_text()

print(f"Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¾ {len(full_text)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²")
```

**Ğ’Ñ‹Ñ…Ğ¾Ğ´:**
```
Ğ¢ĞµĞºÑÑ‚ (ÑÑ‚Ñ€Ğ¾ĞºĞ°):
"ĞŸĞ ĞĞ•ĞšĞ¢ĞĞĞ¯ Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢ĞĞ¦Ğ˜Ğ¯
Ğ Ğ°Ğ·Ğ´ĞµĞ»: ĞÑ‚Ğ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ğ¸Ñ
...
Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
1. Ğ¢Ñ€ÑƒĞ±Ğ° ĞŸĞĞ” d=32Ğ¼Ğ¼ Ğ“ĞĞ¡Ğ¢ 18599-2001 - 150 Ğ¼
2. Ğ¤Ğ¸Ñ‚Ğ¸Ğ½Ğ³Ğ¸ ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ - 25 ÑˆÑ‚
..."

Ğ”Ğ»Ğ¸Ğ½Ğ°: ~50,000 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
```

**Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”:**
```sql
UPDATE documents
SET ocr_text = 'ĞŸĞ ĞĞ•ĞšĞ¢ĞĞĞ¯ Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢ĞĞ¦Ğ˜Ğ¯...'
WHERE id = 456;
```

---

### Ğ­Ñ‚Ğ°Ğ¿ 3: ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ½Ğ¾Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· LLM

**Ğ’Ñ…Ğ¾Ğ´ Ğ² GPT-4o:**
```python
prompt = f"""
Ğ¢Ñ‹ ÑĞºÑĞ¿ĞµÑ€Ñ‚ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸.

Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸:
1. ĞšĞ°ĞºĞ¸Ğµ Ğ²Ğ¸Ğ´Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ÑÑ‚ÑŒ ĞĞĞ¡Ğ 
2. Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ²Ğ¸Ğ´Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚
3. ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ‹ Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ

Ğ’ĞµÑ€Ğ½Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ² JSON Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ:
{{
  "works": [
    {{
      "type": "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚",
      "materials": [
        {{"name": "...", "quantity": ..., "unit": "...", "gost": "..."}}
      ]
    }}
  ]
}}

Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢:
{full_text}
"""

response = openai.chat.completions.create(
    model="gpt-4o",
    messages=[
        {"role": "system", "content": "Ğ¢Ñ‹ ÑĞºÑĞ¿ĞµÑ€Ñ‚ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸."},
        {"role": "user", "content": prompt}
    ],
    temperature=0.2,
    response_format={"type": "json_object"}
)

result = json.loads(response.choices[0].message.content)
```

**Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ¾Ñ‚ GPT-4o:**
```json
{
  "works": [
    {
      "type": "ĞœĞ¾Ğ½Ñ‚Ğ°Ğ¶ Ñ‚Ñ€ÑƒĞ±Ğ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¾Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¾Ñ‚Ğ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ",
      "description": "ĞœĞ¾Ğ½Ñ‚Ğ°Ğ¶ Ñ‚Ñ€ÑƒĞ±Ğ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¾Ğ² Ğ¸Ğ· Ñ‚Ñ€ÑƒĞ± ĞŸĞĞ”",
      "materials": [
        {
          "name": "Ğ¢Ñ€ÑƒĞ±Ğ° ĞŸĞĞ”",
          "specification": "d=32Ğ¼Ğ¼",
          "gost": "Ğ“ĞĞ¡Ğ¢ 18599-2001",
          "quantity": 150,
          "unit": "Ğ¼",
          "manufacturer": null
        },
        {
          "name": "Ğ¤Ğ¸Ñ‚Ğ¸Ğ½Ğ³Ğ¸ ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ",
          "specification": "d=32Ğ¼Ğ¼",
          "gost": null,
          "quantity": 25,
          "unit": "ÑˆÑ‚",
          "manufacturer": null
        }
      ]
    }
  ]
}
```

**Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”:**
```sql
INSERT INTO aosr (
  project_id,
  work_type,
  work_description,
  content,
  status
) VALUES (
  123,
  'ĞœĞ¾Ğ½Ñ‚Ğ°Ğ¶ Ñ‚Ñ€ÑƒĞ±Ğ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¾Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¾Ñ‚Ğ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ',
  'ĞœĞ¾Ğ½Ñ‚Ğ°Ğ¶ Ñ‚Ñ€ÑƒĞ±Ğ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¾Ğ² Ğ¸Ğ· Ñ‚Ñ€ÑƒĞ± ĞŸĞĞ”',
  '{"works": [...], "materials": [...]}'::jsonb,
  'draft'
);
```

---

### Ğ­Ñ‚Ğ°Ğ¿ 4: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞĞĞ¡Ğ 

**Ğ’Ñ…Ğ¾Ğ´:**
```python
# Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ‘Ğ”
aosr_data = {
  "id": 789,
  "work_type": "ĞœĞ¾Ğ½Ñ‚Ğ°Ğ¶ Ñ‚Ñ€ÑƒĞ±Ğ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¾Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¾Ñ‚Ğ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ",
  "materials": [
    {"name": "Ğ¢Ñ€ÑƒĞ±Ğ° ĞŸĞĞ” d=32Ğ¼Ğ¼", "quantity": 150, "unit": "Ğ¼"},
    {"name": "Ğ¤Ğ¸Ñ‚Ğ¸Ğ½Ğ³Ğ¸ ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ", "quantity": 25, "unit": "ÑˆÑ‚"}
  ],
  "work_date": "2024-12-10",
  "project": {
    "name": "Ğ–Ğš Ğ¡Ğ¾Ğ»Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹",
    "address": "Ğ³. ĞœĞ¾ÑĞºĞ²Ğ°, ÑƒĞ». Ğ›ĞµĞ½Ğ¸Ğ½Ğ°, Ğ´. 1"
  },
  "responsible_persons": {
    "contractor": "ĞĞĞ Ğ¡Ñ‚Ñ€Ğ¾Ğ¹ĞŸÑ€Ğ¾Ğ¼",
    "engineer": "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜.Ğ˜.",
    "supervisor": "ĞŸĞµÑ‚Ñ€Ğ¾Ğ² ĞŸ.ĞŸ."
  }
}
```

**ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°:**
```python
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas

def generate_aosr_pdf(data):
    filename = f"aosr_{data['id']}.pdf"
    c = canvas.Canvas(filename, pagesize=A4)

    # Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº
    c.drawString(100, 800, "ĞĞšĞ¢Ğ« ĞĞ¡Ğ’Ğ˜Ğ”Ğ•Ğ¢Ğ•Ğ›Ğ¬Ğ¡Ğ¢Ğ’ĞĞ’ĞĞĞ˜Ğ¯ Ğ¡ĞšĞ Ğ«Ğ¢Ğ«Ğ¥ Ğ ĞĞ‘ĞĞ¢")
    c.drawString(100, 780, f"ĞĞ±ÑŠĞµĞºÑ‚: {data['project']['name']}")
    c.drawString(100, 760, f"ĞĞ´Ñ€ĞµÑ: {data['project']['address']}")

    # Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚
    y = 720
    c.drawString(100, y, "ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚:")
    c.drawString(100, y-20, data['work_type'])

    # Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ²
    y = 660
    c.drawString(100, y, "ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹:")

    for i, material in enumerate(data['materials']):
        y -= 20
        line = f"{i+1}. {material['name']} - {material['quantity']} {material['unit']}"
        c.drawString(120, y, line)

    # ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸
    y = 400
    c.drawString(100, y, f"ĞŸĞ¾Ğ´Ñ€ÑĞ´Ñ‡Ğ¸Ğº: {data['responsible_persons']['contractor']}")
    c.drawString(100, y-20, f"Ğ˜Ğ½Ğ¶ĞµĞ½ĞµÑ€ ĞŸĞ¢Ğ: {data['responsible_persons']['engineer']}")
    c.drawString(100, y-40, f"Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ½Ğ°Ğ´Ğ·Ğ¾Ñ€: {data['responsible_persons']['supervisor']}")

    # Ğ”Ğ°Ñ‚Ğ°
    c.drawString(100, 100, f"Ğ”Ğ°Ñ‚Ğ°: {data['work_date']}")

    c.save()
    return filename
```

**Ğ’Ñ‹Ñ…Ğ¾Ğ´:**
```
Ğ¤Ğ°Ğ¹Ğ»: aosr_789.pdf
Ğ Ğ°Ğ·Ğ¼ĞµÑ€: 250 KB
Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: PDF/A (Ğ´Ğ»Ñ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ)
```

**Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ:**
```python
# Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ² Object Storage
s3_client.upload_file(
    'aosr_789.pdf',
    'pto-platform',
    'projects/123/aosr/aosr_789.pdf'
)

# ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ‘Ğ”
UPDATE aosr
SET
  status = 'generated',
  generated_pdf_path = 'projects/123/aosr/aosr_789.pdf',
  generated_at = NOW()
WHERE id = 789;
```

---

### Ğ­Ñ‚Ğ°Ğ¿ 5: ĞŸĞ¾Ğ¸ÑĞº Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°

**Ğ’Ñ…Ğ¾Ğ´:**
```python
material = {
  "name": "Ğ¢Ñ€ÑƒĞ±Ğ° ĞŸĞĞ”",
  "gost": "Ğ“ĞĞ¡Ğ¢ 18599-2001",
  "quantity": 150,
  "unit": "Ğ¼"
}
```

**Ğ¨Ğ°Ğ³ 5.1: ĞŸĞ¾Ğ¸ÑĞº Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ğµ**

```sql
SELECT * FROM documents
WHERE project_id = 123
  AND doc_type IN ('ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚', 'Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ', 'Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚')
  AND (
    ocr_text ILIKE '%Ğ¢Ñ€ÑƒĞ±Ğ° ĞŸĞĞ”%'
    OR ocr_text ILIKE '%Ğ“ĞĞ¡Ğ¢ 18599-2001%'
  );
```

**Ğ•ÑĞ»Ğ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾:**
```json
{
  "document_id": 234,
  "filename": "Ğ¡ĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚_Ñ‚Ñ€ÑƒĞ±Ğ°_ĞŸĞĞ”.pdf",
  "match_score": 0.85,
  "metadata": {
    "material": "Ğ¢Ñ€ÑƒĞ±Ğ° ĞŸĞĞ”",
    "gost": "Ğ“ĞĞ¡Ğ¢ 18599-2001",
    "manufacturer": "ĞĞĞ ĞŸĞ¾Ğ»Ğ¸Ğ¿Ğ»Ğ°ÑÑ‚Ğ¸Ğº",
    "valid_until": "2027-01-01"
  }
}
```

**Ğ¨Ğ°Ğ³ 5.2: Ğ•ÑĞ»Ğ¸ ĞĞ• Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â†’ ĞŸĞ¾Ğ¸ÑĞº Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ğµ**

```python
from playwright.sync_api import sync_playwright

def search_document_online(material_name, gost):
    with sync_playwright() as p:
        browser = p.chromium.launch()
        page = browser.new_page()

        # Ğ—Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚
        page.goto("https://www.santech.ru/")

        # Ğ˜Ñ‰ĞµĞ¼
        search_query = f"{material_name} {gost} ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚"
        page.fill('input[name="q"]', search_query)
        page.click('button[type="submit"]')

        # Ğ–Ğ´Ñ‘Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
        page.wait_for_selector('.search-results')

        # Ğ‘ĞµÑ€Ñ‘Ğ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        first_result = page.query_selector('.search-results .item')
        pdf_link = first_result.query_selector('a[href$=".pdf"]')

        if pdf_link:
            pdf_url = pdf_link.get_attribute('href')

            # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ PDF
            response = page.goto(pdf_url)
            pdf_content = response.body()

            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼
            with open('found_certificate.pdf', 'wb') as f:
                f.write(pdf_content)

            browser.close()
            return 'found_certificate.pdf'

        browser.close()
        return None
```

**Ğ¨Ğ°Ğ³ 5.3: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· LLM**

```python
# Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ PDF
found_text = extract_text_from_pdf('found_certificate.pdf')

# Ğ¡Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ GPT-4o
prompt = f"""
ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ, Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ Ğ´Ğ»Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ° "{material_name} {gost}".

Ğ¡ĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚:
{found_text}

ĞÑ‚Ğ²ĞµÑ‚ÑŒ Ğ² JSON:
{{
  "matches": true/false,
  "confidence": 0-1,
  "reason": "Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚"
}}
"""

response = openai.chat.completions.create(...)
result = json.loads(response.choices[0].message.content)

if result['matches'] and result['confidence'] > 0.8:
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ² Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
    save_document_to_project(...)
```

**Ğ’Ñ‹Ñ…Ğ¾Ğ´:**
```json
{
  "found": true,
  "source": "internet",
  "url": "https://www.santech.ru/certificates/123.pdf",
  "confidence": 0.92,
  "saved_as": "documents/cert_456.pdf"
}
```

---

### Ğ­Ñ‚Ğ°Ğ¿ 6: Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Ğ°

**Ğ’ĞĞ–ĞĞ:** ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ° Ğ² [10-final-package-generation.md](10-final-package-generation.md)

**Ğ’Ñ…Ğ¾Ğ´:**
```python
project_id = 123
```

**Ğ¨Ğ°Ğ³ 6.1: Ğ¡Ğ±Ğ¾Ñ€ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†**

```python
from dataclasses import dataclass
from typing import List

@dataclass
class DocumentMetadata:
    number: int          # â„– Ğ¿/Ğ¿ Ğ² Ñ€ĞµĞµÑÑ‚Ñ€Ğµ
    name: str           # "ĞĞĞ¡Ğ  01-ĞšĞ–6-1"
    content: str        # "Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ³Ñ€ÑƒĞ½Ñ‚Ğ°"
    doc_number: str     # "01-ĞšĞ–6-1"
    doc_date: date      # 2024-06-07
    page_count: int     # 2
    start_page: int     # 5 (ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ² Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼ PDF)

# Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ñ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
all_metadata = []
current_page = 1  # ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚

# Ğ¢Ğ¸Ñ‚ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ»Ğ¸ÑÑ‚ (1 ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°)
current_page += 1

# Ğ ĞµĞµÑÑ‚Ñ€ (2-3 ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹, Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²)
registry_pages = calculate_registry_pages(project_id)
current_page += registry_pages

# Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ĞĞĞ¡Ğ 
for aosr in aosr_list:
    # ĞĞĞ¡Ğ 
    aosr_pdf = download_from_storage(aosr.generated_pdf_path)
    aosr_page_count = get_pdf_page_count(aosr_pdf)

    all_metadata.append(DocumentMetadata(
        number=len(all_metadata) + 1,
        name=f"ĞĞĞ¡Ğ  {aosr.number}",
        content=aosr.work_description,
        doc_number=aosr.number,
        doc_date=aosr.work_date,
        page_count=aosr_page_count,
        start_page=current_page
    ))
    current_page += aosr_page_count

    # Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°
    if aosr.schema_document_id:
        schema_pdf = download_from_storage(schema.file_path)
        schema_page_count = get_pdf_page_count(schema_pdf)

        all_metadata.append(DocumentMetadata(
            number=len(all_metadata) + 1,
            name=f"Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° {aosr.number}",
            content="ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ â„–1",
            doc_number=aosr.number,
            doc_date=aosr.work_date,
            page_count=schema_page_count,
            start_page=current_page
        ))
        current_page += schema_page_count

    # Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°
    for qd in quality_docs:
        doc_pdf = download_from_storage(doc.file_path)
        doc_page_count = get_pdf_page_count(doc_pdf)

        all_metadata.append(DocumentMetadata(
            number=len(all_metadata) + 1,
            name=doc.doc_type,
            content=doc.metadata.get('material_name', ''),
            doc_number=doc.metadata.get('cert_number', ''),
            doc_date=doc.metadata.get('issue_date'),
            page_count=doc_page_count,
            start_page=current_page
        ))
        current_page += doc_page_count
```

**Ğ¨Ğ°Ğ³ 6.2: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ€ĞµĞµÑÑ‚Ñ€Ğ° Ñ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°Ğ¼Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†**

```python
def generate_registry_pdf(project_info: Dict, all_metadata: List[DocumentMetadata], output_path: str):
    """
    Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€ĞµĞµÑÑ‚Ñ€ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸

    Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ñ€ĞµĞµÑÑ‚Ñ€Ğ°:
    â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚â„–Ğ¿/Ğ¿â”‚  ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ    â”‚  Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ  â”‚â„– Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° â”‚   Ğ”Ğ°Ñ‚Ğ°   â”‚ĞšĞ¾Ğ»-Ğ²Ğ¾ Ğ». â”‚Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°  â”‚
    â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 1  â”‚ĞĞĞ¡Ğ  01-ĞšĞ–6-1    â”‚Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°    â”‚01-ĞšĞ–6-1    â”‚07.06.2024â”‚    2     â”‚    5     â”‚
    â”‚    â”‚                  â”‚Ğ³Ñ€ÑƒĞ½Ñ‚Ğ°        â”‚            â”‚          â”‚          â”‚          â”‚
    â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 2  â”‚Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ    â”‚ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ â„–1 â”‚01-ĞšĞ–6-1    â”‚07.06.2024â”‚    1     â”‚    7     â”‚
    â”‚    â”‚ÑÑ…ĞµĞ¼Ğ° 01-ĞšĞ–6-1    â”‚              â”‚            â”‚          â”‚          â”‚          â”‚
    â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    from reportlab.pdfgen import canvas

    c = canvas.Canvas(output_path, pagesize=A4)

    # Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ€ĞµĞµÑÑ‚Ñ€Ğ°
    c.setFont("DejaVuBold", 14)
    c.drawCentredString(width/2, height - 30*mm, "Ğ Ğ•Ğ•Ğ¡Ğ¢Ğ  Ğ˜Ğ¡ĞŸĞĞ›ĞĞ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞĞ™ Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢ĞĞ¦Ğ˜Ğ˜")

    # Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ
    # ... (ĞºĞ¾Ğ´ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°)

    # Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
    for doc_meta in all_metadata:
        # Ğ Ğ¸ÑÑƒĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
        draw_table_row(c, doc_meta)

    c.save()
    return output_path
```

**Ğ¨Ğ°Ğ³ 6.3: ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ² ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ PDF**

```python
from PyPDF2 import PdfMerger

def create_final_package(project_id: int, output_pdf_path: str):
    merger = PdfMerger()

    # 1. Ğ¢Ğ¸Ñ‚ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ»Ğ¸ÑÑ‚
    title_pdf = generate_title_page(project_info)
    merger.append(title_pdf)

    # 2. ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ€ĞµĞµÑÑ‚Ñ€ (Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°Ğ¼Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†)
    registry_pdf = generate_registry_pdf(project_info, all_metadata)
    merger.append(registry_pdf)

    # 3. Ğ’ÑĞµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ² Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ Ñ€ĞµĞµÑÑ‚Ñ€Ğ°
    for doc_meta in all_metadata:
        pdf_path = get_pdf_by_metadata(doc_meta)
        merger.append(pdf_path)

    # 4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
    merger.write(output_pdf_path)
    merger.close()

    return output_pdf_path
```

**Ğ¨Ğ°Ğ³ 6.4: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ° Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğ¼Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸**

```python
import zipfile
import openpyxl

def create_editable_archive(project_id: int, output_zip_path: str):
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ZIP Ğ°Ñ€Ñ…Ğ¸Ğ² ÑĞ¾ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¾Ğ¹:
    â”œâ”€â”€ 1. Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ PDF/
    â”œâ”€â”€ 2. Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Excel/
    â”‚   â”œâ”€â”€ ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ€ĞµĞµÑÑ‚Ñ€.xlsx
    â”‚   â””â”€â”€ ĞĞĞ¡Ğ  â„–1.xlsx, ĞĞĞ¡Ğ  â„–2.xlsx, ...
    â”œâ”€â”€ 4. Ğ“ĞµĞ¾Ğ´ĞµĞ·Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑÑ…ĞµĞ¼Ñ‹ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ DWG/
    â””â”€â”€ 5. ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°, ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ¸ Ğ»Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ/
    """
    with zipfile.ZipFile(output_zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:

        # ĞŸĞ°Ğ¿ĞºĞ° 1: PDF Ñ„Ğ°Ğ¹Ğ»Ñ‹
        for aosr in aosr_list:
            zipf.write(aosr.pdf_path, f"1. Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ PDF/ĞĞĞ¡Ğ  {aosr.number}.pdf")

        # ĞŸĞ°Ğ¿ĞºĞ° 2: Excel Ñ„Ğ°Ğ¹Ğ»Ñ‹
        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞµÑÑ‚Ñ€ Ğ² Excel
        registry_excel = generate_registry_excel(project_info, all_metadata)
        zipf.write(registry_excel, "2. Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Excel/ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ€ĞµĞµÑÑ‚Ñ€.xlsx")

        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ĞĞĞ¡Ğ  Ğ² Excel (Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°)
        for aosr in aosr_list:
            aosr_excel = generate_aosr_excel(aosr)
            zipf.write(aosr_excel, f"2. Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Excel/ĞĞĞ¡Ğ  {aosr.number}.xlsx")

        # ĞŸĞ°Ğ¿ĞºĞ° 5: Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°
        for doc in quality_docs:
            zipf.write(doc.file_path, f"5. ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°, ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ¸ Ğ»Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ/{doc.filename}")

    return output_zip_path
```

**Ğ’Ñ‹Ñ…Ğ¾Ğ´:**

```json
{
  "pdf": {
    "path": "storage/projects/123/final_package.pdf",
    "size_mb": 45,
    "pages": 250,
    "structure": {
      "title_page": 1,
      "registry": "2-4",
      "aosr_count": 8,
      "schema_count": 8,
      "quality_docs_count": 24
    }
  },
  "zip": {
    "path": "storage/projects/123/final_archive.zip",
    "size_mb": 30,
    "structure": {
      "pdf_folder": "1. Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ PDF/",
      "excel_folder": "2. Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Excel/",
      "dwg_folder": "4. Ğ“ĞµĞ¾Ğ´ĞµĞ·Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑÑ…ĞµĞ¼Ñ‹ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ DWG/",
      "quality_folder": "5. ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°, ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ¸ Ğ»Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ/"
    }
  }
}
```

---

## ğŸ”„ Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```
RAW DATA (Ğ’Ñ…Ğ¾Ğ´)
â”œâ”€ PDF Ñ„Ğ°Ğ¹Ğ» (15 MB, Ğ½ĞµÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹)
â”‚
â”‚ â†“ [OCR / Text Extraction]
â”‚
â”œâ”€ Ğ¢ĞµĞºÑÑ‚ (50,000 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², plain text)
â”‚
â”‚ â†“ [LLM Analysis]
â”‚
â”œâ”€ JSON ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° (Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ + Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹)
â”‚  {
â”‚    "works": [...],
â”‚    "materials": [...]
â”‚  }
â”‚
â”‚ â†“ [Template Filling]
â”‚
â”œâ”€ Formatted AOSR (PDF, 250 KB)
â”‚
â”‚ â†“ [Document Search]
â”‚
â”œâ”€ Quality Documents (ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹, Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°)
â”‚
â”‚ â†“ [PDF Merge]
â”‚
â””â”€ FINAL PACKAGE (PDF, 45 MB, ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹)
```

---

## ğŸ“¦ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ

| Ğ­Ñ‚Ğ°Ğ¿ | Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ | Ğ“Ğ´Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ | Ğ Ğ°Ğ·Ğ¼ĞµÑ€ (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾) |
|------|--------|--------------|-------------------|
| Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° | PDF | Object Storage | 15 MB |
| Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ° | TEXT | PostgreSQL (Ğ¿Ğ¾Ğ»Ğµ `ocr_text`) | 50 KB |
| ĞĞ½Ğ°Ğ»Ğ¸Ğ· LLM | JSON | PostgreSQL (Ğ¿Ğ¾Ğ»Ğµ `content` JSONB) | 5 KB |
| Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞĞĞ¡Ğ  | PDF | Object Storage | 250 KB |
| ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ | PDF | Object Storage | 1-5 MB ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ |
| Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚ | PDF | Object Storage | 45 MB |

---

## ğŸ” ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²

**ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:**

```json
{
  "document_id": 456,
  "project_id": 123,
  "filename": "Ğ Ğ°Ğ·Ğ´ĞµĞ» ĞĞ’.pdf",
  "doc_type": "Ğ Ğ”",
  "uploaded_at": "2024-12-14T10:00:00Z",
  "uploaded_by": "user_1",
  "file_size": 15728640,
  "mime_type": "application/pdf",
  "ocr_status": "completed",
  "ocr_confidence": 0.95,
  "metadata": {
    "extracted_from_ocr": {
      "document_number": "123-ĞĞ’-ĞŸĞ”",
      "issue_date": "2024-01-15",
      "project_name": "Ğ–Ğš Ğ¡Ğ¾Ğ»Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹",
      "section": "ĞÑ‚Ğ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ğ¸Ñ"
    }
  }
}
```

---

## âš¡ ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² LLM

```python
import hashlib
import redis

redis_client = redis.Redis()

def get_cached_llm_result(prompt):
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ hash Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°
    prompt_hash = hashlib.sha256(prompt.encode()).hexdigest()

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºÑÑˆ
    cached = redis_client.get(f"llm:{prompt_hash}")
    if cached:
        return json.loads(cached)

    # Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ² ĞºÑÑˆĞµ â†’ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº LLM
    result = call_openai(prompt)

    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² ĞºÑÑˆ (Ğ½Ğ° 24 Ñ‡Ğ°ÑĞ°)
    redis_client.setex(f"llm:{prompt_hash}", 86400, json.dumps(result))

    return result
```

### 2. ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¾Ğ²Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… PDF

```python
def process_large_pdf_in_chunks(pdf_path, chunk_size=10):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ PDF Ğ¿Ğ¾ Ñ‡Ğ°ÑÑ‚ÑĞ¼ (Ğ¿Ğ¾ 10 ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†)"""
    doc = fitz.open(pdf_path)
    total_pages = len(doc)

    for start in range(0, total_pages, chunk_size):
        end = min(start + chunk_size, total_pages)

        # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· Ñ‡Ğ°Ğ½ĞºĞ°
        chunk_text = ""
        for page_num in range(start, end):
            chunk_text += doc[page_num].get_text()

        # ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ğ°Ğ½Ğº
        yield process_chunk(chunk_text)
```

### 3. ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ²

```python
from concurrent.futures import ThreadPoolExecutor

def search_all_materials_parallel(materials):
    """Ğ˜Ñ‰ĞµÑ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ² Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾"""
    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = [
            executor.submit(search_document, material)
            for material in materials
        ]

        results = [future.result() for future in futures]
        return results
```

---

## ğŸ¯ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

ĞŸÑ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ¹Ñ‚Ğµ:
- [03-agents-interaction.md](03-agents-interaction.md) â€” ĞšĞ°Ğº Ğ˜Ğ˜-Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ¸Ñ€ÑƒÑÑ‚ÑÑ
- [04-scaling-strategy.md](04-scaling-strategy.md) â€” ĞšĞ°Ğº Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

---

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… ĞĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾
**ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:** 2025-12-14
