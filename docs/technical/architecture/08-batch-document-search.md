# Пакетный поиск документов качества

> Детальная схема пакетной обработки недостающих документов с выбором пользователя

---

## Содержание

1. [Общая схема](#общая-схема)
2. [Этап 1: Сбор результатов](#этап-1-сбор-результатов)
3. [Этап 2: Пакетный отчёт](#этап-2-пакетный-отчёт)
4. [Этап 3: Параллельный поиск](#этап-3-параллельный-поиск)
5. [Этап 4: Отчёт после поиска](#этап-4-отчёт-после-поиска)
6. [Этап 5: Генерация AI](#этап-5-генерация-ai)

---

## Общая схема

```
Материалы (15 шт)
       ↓
┌──────────────────┐
│ Поиск в БД       │ → Найдено: 7
└──────────────────┘
       ↓
┌──────────────────┐
│ Поиск на сайтах  │ → Найдено: 0
└──────────────────┘
       ↓
┌──────────────────────────────────────┐
│ ПАКЕТНЫЙ ОТЧЁТ (7 найдено, 8 нет)   │
│                                      │
│ Пользователь выбирает:               │
│ ☑ 5 документов для поиска в Google   │
│ ☐ 3 документа пропустить             │
└──────────────────────────────────────┘
       ↓
┌──────────────────┐
│ Параллельный     │ → Найдено: 3 из 5
│ поиск в Google   │   Не найдено: 2
└──────────────────┘
       ↓
┌──────────────────────────────────────┐
│ ОТЧЁТ ПОСЛЕ ПОИСКА                   │
│                                      │
│ Пользователь выбирает:               │
│ ☑ 2 документа для генерации AI       │
│ ☐ 3 документа загрузит вручную       │
└──────────────────────────────────────┘
       ↓
┌──────────────────┐
│ Генерация AI     │ → Создано: 2
└──────────────────┘
       ↓
Итого: 7 (БД) + 3 (интернет) + 2 (AI) = 12
Остаток: 3 (загрузит пользователь вручную)
```

---

## Этап 1: Сбор результатов

```
┌─────────────────────────────────────────────────────────────────────┐
│ СБОР РЕЗУЛЬТАТОВ ПОИСКА (Levels 1-2)                                │
└─────────────────────────────────────────────────────────────────────┘

Search Agent         PostgreSQL          Specialized Sites
────────────         ──────────          ─────────────────
     │                    │                      │
     │ For each material  │                      │
     │ (15 materials)     │                      │
     │                    │                      │
     │ Level 1: Check DB  │                      │
     │ SELECT * FROM      │                      │
     │ quality_documents  │                      │
     │ WHERE material =   │                      │
     │ 'Труба REHAU d=16' │                      │
     ├───────────────────►│                      │
     │                    │                      │
     │ Found!             │                      │
     │◄───────────────────┤                      │
     │                    │                      │
     │ Store result:      │                      │
     │ {                  │                      │
     │   material_id: 1,  │                      │
     │   status: "found", │                      │
     │   source: "db",    │                      │
     │   doc_id: "qd_123" │                      │
     │ }                  │                      │
     │                    │                      │
     │ ... (repeat for    │                      │
     │      all materials)│                      │
     │                    │                      │
     │ Results summary:   │                      │
     │ found_in_db = [    │                      │
     │   {id:1, name:...},│                      │
     │   {id:2, name:...},│                      │
     │   ... x7           │                      │
     │ ]                  │                      │
     │                    │                      │
     │ Level 2: Specialized│                     │
     │ sites for remaining│                      │
     │ (8 materials)      │                      │
     │                    │                      │
     │ Search on          │                      │
     │ santech.ru,        │                      │
     │ petrovich.ru       │                      │
     │ (Playwright)       │                      │
     ├────────────────────────────────────────────►
     │                    │                      │
     │                    │                      │ No results found
     │◄────────────────────────────────────────────
     │                    │                      │
     │ Final tally:       │                      │
     │ found: 7           │                      │
     │ not_found: 8       │                      │
     │                    │                      │
```

---

## Этап 2: Пакетный отчёт

```
┌─────────────────────────────────────────────────────────────────────┐
│ ПАКЕТНОЕ УВЕДОМЛЕНИЕ ПОЛЬЗОВАТЕЛЯ                                   │
└─────────────────────────────────────────────────────────────────────┘

Search Agent      WebSocket       Frontend         User
────────────      ─────────       ────────         ────
     │                 │              │              │
     │ Build report    │              │              │
     │ {               │              │              │
     │   found: [      │              │              │
     │     {id:1,name, │              │              │
     │      source:"db"│              │              │
     │     }, ... x7   │              │              │
     │   ],            │              │              │
     │   not_found: [  │              │              │
     │     {id:8,name: │              │              │
     │      "Труба     │              │              │
     │      REHAU d=20"│              │              │
     │     },          │              │              │
     │     {id:9,name: │              │              │
     │      "Труба     │              │              │
     │      REHAU d=25"│              │              │
     │     },          │              │              │
     │     ... x8      │              │              │
     │   ]             │              │              │
     │ }               │              │              │
     │                 │              │              │
     │ Send via        │              │              │
     │ WebSocket       │              │              │
     │ ws.send({       │              │              │
     │   type:         │              │              │
     │   "batch_report"│              │              │
     │   data: {...}   │              │              │
     │ })              │              │              │
     ├────────────────►│              │              │
     │                 │              │              │
     │                 │ Render UI    │              │
     │                 ├─────────────►│              │
     │                 │              │              │
     │                 │              │ ┌────────────────────────────┐
     │                 │              │ │ 📋 Результаты поиска       │
     │                 │              │ │    документов качества     │
     │                 │              │ ├────────────────────────────┤
     │                 │              │ │                            │
     │                 │              │ │ ✅ НАЙДЕНО В БАЗЕ          │
     │                 │              │ │    (7 документов)          │
     │                 │              │ │                            │
     │                 │              │ │  • Труба REHAU d=16мм      │
     │                 │              │ │    Сертификат №С-РУ.123   │
     │                 │              │ │    Дата: 2023-01-15        │
     │                 │              │ │                            │
     │                 │              │ │  • Фитинг REHAU угловой    │
     │                 │              │ │    Паспорт качества №456   │
     │                 │              │ │                            │
     │                 │              │ │  • ... (показать все 7)    │
     │                 │              │ │                            │
     │                 │              │ ├────────────────────────────┤
     │                 │              │ │ ⚠️ НЕ НАЙДЕНО              │
     │                 │              │ │    (8 документов)          │
     │                 │              │ │                            │
     │                 │              │ │ Выберите документы для     │
     │                 │              │ │ поиска в интернете:        │
     │                 │              │ │                            │
     │                 │              │ │ [✓] Труба REHAU d=20мм     │
     │                 │              │ │ [✓] Труба REHAU d=25мм     │
     │                 │              │ │ [✓] Клапан Danfoss RA-N 15 │
     │                 │              │ │ [ ] Утеплитель Rockwool    │
     │                 │              │ │ [✓] Краска Tikkurila белая │
     │                 │              │ │ [ ] Грунтовка ГФ-021       │
     │                 │              │ │ [✓] Крепёж дюбель 6x40     │
     │                 │              │ │ [ ] Лента ФУМ              │
     │                 │              │ │                            │
     │                 │              │ │ Выбрано: 5 из 8            │
     │                 │              │ │                            │
     │                 │              │ │ Для невыбранных (3):       │
     │                 │              │ │ ○ Пропустить               │
     │                 │              │ │ ● Сгенерировать AI         │
     │                 │              │ │                            │
     │                 │              │ │ [Искать выбранные (5)]     │
     │                 │              │ │ [Выбрать все] [Снять все]  │
     │                 │              │ │ [Отмена]                   │
     │                 │              │ └────────────────────────────┘
     │                 │              │              │
     │                 │              │ User selects │
     │                 │              │ checkboxes & │
     │                 │              │ clicks button│
     │                 │              │◄─────────────┤
     │                 │              │              │
     │                 │ POST /api/   │              │
     │                 │ search-batch │              │
     │                 │ {            │              │
     │                 │   selected:  │              │
     │                 │   [8,9,10,   │              │
     │                 │    12,14],   │              │
     │                 │   skipped:   │              │
     │                 │   [11,13,15],│              │
     │                 │   skip_action│              │
     │                 │   "generate" │              │
     │                 │ }            │              │
     │                 │◄─────────────┤              │
     │                 │              │              │
     │ Receive request │              │              │
     │◄────────────────┤              │              │
     │                 │              │              │
     │ Validate        │              │              │
     │ selection       │              │              │
     │                 │              │              │
     │ Enqueue tasks:  │              │              │
     │ - 5 search tasks│              │              │
     │ - 3 generate    │              │              │
     │   tasks (queued │              │              │
     │   after search) │              │              │
     │                 │              │              │
     │ Response        │              │              │
     │ 202 Accepted    │              │              │
     │ {               │              │              │
     │   search_job_id │              │              │
     │   task_ids: [...│              │              │
     │ }               │              │              │
     ├────────────────►│              │              │
     │                 │              │              │
     │                 │ Show progress│              │
     │                 ├─────────────►│              │
     │                 │              │              │
     │                 │              │ ┌────────────────────┐
     │                 │              │ │ 🔍 Идёт поиск...   │
     │                 │              │ │                    │
     │                 │              │ │ Поиск в интернете: │
     │                 │              │ │ ██████░░░░ 3/5     │
     │                 │              │ │                    │
     │                 │              │ │ • Труба d=20 ✓     │
     │                 │              │ │ • Труба d=25 ✓     │
     │                 │              │ │ • Клапан... ⏳     │
     │                 │              │ │ • Краска... ⏱      │
     │                 │              │ │ • Крепёж... ⏱      │
     │                 │              │ └────────────────────┘
     │                 │              │              │
```

---

## Этап 3: Параллельный поиск

```
┌─────────────────────────────────────────────────────────────────────┐
│ ПАРАЛЛЕЛЬНЫЙ ПОИСК В ИНТЕРНЕТЕ (5 документов одновременно)          │
└─────────────────────────────────────────────────────────────────────┘

Celery Queue      Worker 1        Worker 2        Worker 3
────────────      ────────        ────────        ────────
     │                │               │               │
     │ 5 tasks        │               │               │
     │ in queue       │               │               │
     │                │               │               │
     │ Assign task 1  │               │               │
     ├───────────────►│               │               │
     │                │               │               │
     │                │ Search:       │               │
     │                │ "Труба REHAU  │               │
     │                │  d=20мм"      │               │
     │                │               │               │
     │ Assign task 2  │               │               │
     ├──────────────────────────────►│               │
     │                │               │               │
     │                │               │ Search:       │
     │                │               │ "Труба REHAU  │
     │                │               │  d=25мм"      │
     │                │               │               │
     │ Assign task 3  │               │               │
     ├─────────────────────────────────────────────►│
     │                │               │               │
     │                │               │               │ Search:
     │                │               │               │ "Клапан
     │                │               │               │  Danfoss"
     │                │               │               │
     │                │ Google Search │               │
     │                │ + Playwright  │               │
     │                │ ↓             │               │
     │                │ Found on      │               │
     │                │ santech.ru    │               │
     │                │               │               │
     │ Result 1       │               │               │
     │◄───────────────┤               │               │
     │                │               │               │
     │ Update DB      │               │ Google Search │
     │ Save doc       │               │ + Playwright  │
     │                │               │ ↓             │
     │                │               │ Found on      │
     │                │               │ Google        │
     │                │               │               │
     │ Result 2       │               │               │
     │◄──────────────────────────────┤               │
     │                │               │               │
     │ Update DB      │               │               │
     │ Save doc       │               │               │ Google
     │                │               │               │ Search
     │                │               │               │ ↓
     │                │               │               │ NOT FOUND
     │                │               │               │
     │ Result 3       │               │               │
     │◄─────────────────────────────────────────────┤
     │                │               │               │
     │ Update DB      │               │               │
     │ Mark as        │               │               │
     │ "not_found"    │               │               │
     │                │               │               │
     │ ... tasks 4,5  │               │               │
     │ continue...    │               │               │
     │                │               │               │
     │ All 5 done:    │               │               │
     │ - Found: 3     │               │               │
     │ - Not found: 2 │               │               │
     │                │               │               │

WebSocket Notifications (Real-time):
────────────────────────────────────

ws.send({type: "search_progress", completed: 1, total: 5})
ws.send({type: "search_progress", completed: 2, total: 5})
ws.send({type: "search_found", material: "Труба d=20", source: "santech.ru"})
ws.send({type: "search_progress", completed: 3, total: 5})
ws.send({type: "search_found", material: "Труба d=25", source: "google"})
ws.send({type: "search_progress", completed: 4, total: 5})
ws.send({type: "search_not_found", material: "Клапан Danfoss"})
ws.send({type: "search_progress", completed: 5, total: 5})
ws.send({type: "search_complete", results: {...}})
```

---

## Этап 4: Отчёт после поиска

```
┌─────────────────────────────────────────────────────────────────────┐
│ ВТОРОЙ ПАКЕТНЫЙ ОТЧЁТ (после поиска в интернете)                    │
└─────────────────────────────────────────────────────────────────────┘

Search Agent      WebSocket       Frontend         User
────────────      ─────────       ────────         ────
     │                 │              │              │
     │ Search complete │              │              │
     │                 │              │              │
     │ Build summary:  │              │              │
     │ found_web: 3    │              │              │
     │ not_found: 2    │              │              │
     │ skipped: 3      │              │              │
     │                 │              │              │
     │ Send report     │              │              │
     │ ws.send({       │              │              │
     │   type: "search_│              │              │
     │   results"      │              │              │
     │   found: [...], │              │              │
     │   not_found:[..]│              │              │
     │   skipped: [...] │              │              │
     │ })              │              │              │
     ├────────────────►│              │              │
     │                 │              │              │
     │                 │ Show results │              │
     │                 ├─────────────►│              │
     │                 │              │              │
     │                 │              │ ┌────────────────────────────┐
     │                 │              │ │ 📊 Результаты поиска       │
     │                 │              │ │    в интернете             │
     │                 │              │ ├────────────────────────────┤
     │                 │              │ │                            │
     │                 │              │ │ ✅ НАЙДЕНО В ИНТЕРНЕТЕ     │
     │                 │              │ │    (3 документа)           │
     │                 │              │ │                            │
     │                 │              │ │  • Труба REHAU d=20мм      │
     │                 │              │ │    📄 santech.ru           │
     │                 │              │ │    Уверенность: 92%        │
     │                 │              │ │                            │
     │                 │              │ │  • Труба REHAU d=25мм      │
     │                 │              │ │    📄 Google               │
     │                 │              │ │    Уверенность: 87%        │
     │                 │              │ │                            │
     │                 │              │ │  • Краска Tikkurila        │
     │                 │              │ │    📄 tikkurila.ru         │
     │                 │              │ │    Уверенность: 95%        │
     │                 │              │ │                            │
     │                 │              │ ├────────────────────────────┤
     │                 │              │ │ ❌ НЕ НАЙДЕНО              │
     │                 │              │ │    даже в интернете        │
     │                 │              │ │    (2 документа)           │
     │                 │              │ │                            │
     │                 │              │ │ [✓] Клапан Danfoss RA-N 15 │
     │                 │              │ │ [✓] Крепёж дюбель 6x40     │
     │                 │              │ │                            │
     │                 │              │ ├────────────────────────────┤
     │                 │              │ │ 🔄 ПРОПУЩЕНО РАНЕЕ         │
     │                 │              │ │    (3 документа)           │
     │                 │              │ │                            │
     │                 │              │ │  • Утеплитель Rockwool     │
     │                 │              │ │  • Грунтовка ГФ-021        │
     │                 │              │ │  • Лента ФУМ               │
     │                 │              │ │                            │
     │                 │              │ │ (будут сгенерированы AI)   │
     │                 │              │ │                            │
     │                 │              │ ├────────────────────────────┤
     │                 │              │ │ Для не найденных (2+3):    │
     │                 │              │ │                            │
     │                 │              │ │ [Сгенерировать AI (2)]     │
     │                 │              │ │ [Загружу вручную позже]    │
     │                 │              │ │ [Выбрать все 5]            │
     │                 │              │ │                            │
     │                 │              │ │ Автоматически будут        │
     │                 │              │ │ сгенерированы: 3 док.      │
     │                 │              │ └────────────────────────────┘
     │                 │              │              │
     │                 │              │ User clicks  │
     │                 │              │ "Сгенерировать│
     │                 │              │ AI (2)"      │
     │                 │              │◄─────────────┤
     │                 │              │              │
     │                 │ POST /api/   │              │
     │                 │ generate-ai  │              │
     │                 │ {            │              │
     │                 │   selected:  │              │
     │                 │   [10,14]    │              │
     │                 │ }            │              │
     │                 │◄─────────────┤              │
     │                 │              │              │
     │ Enqueue AI      │              │              │
     │ generation      │              │              │
     │ tasks: 2+3=5    │              │              │
     │◄────────────────┤              │              │
     │                 │              │              │
```

---

## Этап 5: Генерация AI

```
┌─────────────────────────────────────────────────────────────────────┐
│ ПАРАЛЛЕЛЬНАЯ ГЕНЕРАЦИЯ AI ПАСПОРТОВ (5 документов)                  │
└─────────────────────────────────────────────────────────────────────┘

Celery Queue      AI Worker 1     AI Worker 2     GPT-4o API
────────────      ───────────     ───────────     ──────────
     │                 │               │               │
     │ 5 tasks         │               │               │
     │ in queue        │               │               │
     │                 │               │               │
     │ Assign task 1   │               │               │
     ├────────────────►│               │               │
     │                 │               │               │
     │                 │ Generate for: │               │
     │                 │ "Клапан       │               │
     │                 │  Danfoss"     │               │
     │                 │               │               │
     │                 │ Request GPT   │               │
     │                 │ "Создай       │               │
     │                 │ типовой       │               │
     │                 │ паспорт для   │               │
     │                 │ Клапан..."    │               │
     │                 ├──────────────────────────────►│
     │                 │               │               │
     │                 │               │               │ Generate:
     │                 │               │               │ - ГОСТ refs
     │                 │               │               │ - Properties
     │                 │               │               │ - Specs
     │                 │               │               │
     │                 │ JSON response │               │
     │                 │◄──────────────────────────────┤
     │                 │               │               │
     │                 │ Create PDF    │               │
     │                 │ with ReportLab│               │
     │                 │ + WARNING     │               │
     │                 │ banner        │               │
     │                 │               │               │
     │ Assign task 2   │               │               │
     ├────────────────────────────────►│               │
     │                 │               │               │
     │                 │               │ Generate for: │
     │                 │               │ "Крепёж"      │
     │                 │               │               │
     │                 │               │ (same process)│
     │                 │               │               │
     │                 │ Upload PDF    │               │
     │                 │ to S3         │               │
     │                 │               │               │
     │ Result 1        │               │               │
     │◄────────────────┤               │               │
     │                 │               │               │
     │ ws.send({       │               │               │
     │   type:         │               │               │
     │   "ai_generated"│               │               │
     │   material: "..." │              │               │
     │ })              │               │               │
     │                 │               │               │
     │ ... continue    │               │               │
     │ for all 5       │               │               │
     │                 │               │               │
     │ All complete    │               │               │
     │                 │               │               │
     │ Final summary   │               │               │
     │ ws.send({       │               │               │
     │   type:         │               │               │
     │   "all_complete"│               │               │
     │   stats: {      │               │               │
     │     db: 7,      │               │               │
     │     web: 3,     │               │               │
     │     ai: 5       │               │               │
     │   }             │               │               │
     │ })              │               │               │
```

---

## Итоговая статистика

```
┌────────────────────────────────────────────────────────┐
│ ИТОГОВЫЙ ОТЧЁТ                                         │
├────────────────────────────────────────────────────────┤
│                                                        │
│ Всего материалов: 15                                   │
│                                                        │
│ ✅ Найдено в базе данных:        7  (47%)             │
│ 🌐 Найдено в интернете:          3  (20%)             │
│ 🤖 Сгенерировано AI:             5  (33%)             │
│ ❌ Требуется загрузка вручную:   0  (0%)              │
│                                                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                        │
│ ⚠️  ТРЕБУЮТ ПРОВЕРКИ:                                  │
│     • Из интернета: 3 документа (🟡 пометка)          │
│     • Сгенерированные AI: 5 документов (🔴 пометка)   │
│                                                        │
│ 📋 Готово к использованию: 7 документов               │
│                                                        │
│ [Продолжить с текущими документами]                    │
│ [Загрузить недостающие вручную]                        │
│ [Показать детали]                                      │
└────────────────────────────────────────────────────────┘
```

---

## Преимущества пакетного подхода

### 1. Экономия времени пользователя
- **Было:** 8 отдельных уведомлений → 8 кликов
- **Стало:** 1 уведомление → 1 выбор

### 2. Лучший UX
- Видно полную картину сразу
- Можно принять решение для всех документов одновременно
- Прогресс виден в реальном времени

### 3. Эффективность
- Параллельная обработка всех выбранных документов
- Не нужно ждать ответа по каждому документу

### 4. Контроль
- Пользователь видит что найдено, что нет
- Может выбрать только нужные для поиска
- Экономит деньги на API calls (только для выбранных)

### 5. Прозрачность
- Источник каждого документа виден
- Статистика уверенности для каждого
- Понятно что требует проверки
