# Разбивка действий пользователя

> Пошаговое описание всех действий пользователя от создания проекта до получения финального комплекта ИД

**Дата создания:** 2025-12-15
**Приоритет:** ⭐⭐⭐⭐⭐ (Критический — определяет UX/UI платформы)

---

## Содержание

1. [Общий обзор workflow](#общий-обзор-workflow)
2. [Действие 1: Создание проекта](#1-создание-проекта)
3. [Действие 2: Загрузка рабочей документации](#2-загрузка-рабочей-документации)
4. [Действие 3: Анализ РД и выбор шаблонов](#3-анализ-рд-и-выбор-шаблонов)
5. [Действие 4: Поиск документов качества](#4-поиск-документов-качества)
6. [Действие 5: Генерация АОСР](#5-генерация-аоср)
7. [Действие 6: Проверка и редактирование](#6-проверка-и-редактирование)
8. [Действие 7: Валидация комплекта](#7-валидация-комплекта)
9. [Действие 8: Формирование финального пакета](#8-формирование-финального-пакета)
10. [Временные оценки](#временные-оценки)

---

## Общий обзор workflow

```
┌──────────────────────────────────────────────────────────────────────┐
│ ПОЛНЫЙ ПУТЬ ПОЛЬЗОВАТЕЛЯ (от начала до конца)                       │
└──────────────────────────────────────────────────────────────────────┘

[Вход в систему]
      ↓
┌─────────────────────┐
│ 1. Создание проекта │  ← Заполнение базовой информации
└─────────────────────┘
      ↓
┌─────────────────────┐
│ 2. Загрузка РД      │  ← Загрузка PDF файлов рабочей документации
└─────────────────────┘
      ↓
┌─────────────────────┐
│ 3. Анализ РД        │  ← AI анализирует документы + выбор шаблонов
└─────────────────────┘
      ↓
┌─────────────────────┐
│ 4. Поиск док-тов    │  ← Поиск документов качества (полуавтомат)
│    качества         │
└─────────────────────┘
      ↓
┌─────────────────────┐
│ 5. Генерация АОСР   │  ← Создание актов на основе данных
└─────────────────────┘
      ↓
┌─────────────────────┐
│ 6. Проверка и       │  ← Редактирование АОСР, добавление подписей
│    редактирование   │
└─────────────────────┘
      ↓
┌─────────────────────┐
│ 7. Валидация        │  ← Автоматическая проверка комплекта
└─────────────────────┘
      ↓
┌─────────────────────┐
│ 8. Финальный пакет  │  ← Скачивание PDF и архива
└─────────────────────┘
      ↓
[Готово! 🎉]
```

---

## 1. Создание проекта

### Цель
Создать новый проект и заполнить базовую информацию, необходимую для генерации документов.

### Что делает пользователь

**Шаг 1.1: Нажимает "Создать проект"**

Интерфейс:
```
┌──────────────────────────────────────────────┐
│ 🏗️ Мои проекты                              │
├──────────────────────────────────────────────┤
│                                              │
│  [➕ Создать новый проект]                   │
│                                              │
│  📋 Проект 1: ЖК Новый Дом                  │
│  📋 Проект 2: Офисное здание на Ленина      │
│                                              │
└──────────────────────────────────────────────┘
```

**Шаг 1.2: Заполняет форму проекта**

```
┌──────────────────────────────────────────────────────────────┐
│ Создание нового проекта                                      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ Основная информация:                                         │
│                                                              │
│ Название проекта: *                                          │
│ [_____________________________]                              │
│   Например: "ЖК Солнечный, корпус 1"                         │
│                                                              │
│ Адрес объекта: *                                             │
│ [_____________________________]                              │
│   Например: "г. Москва, ул. Строителей, д. 10"              │
│                                                              │
│ Участники строительства:                                     │
│                                                              │
│ Застройщик: *                                                │
│ [_____________________________]                              │
│                                                              │
│ Генподрядчик: *                                              │
│ [_____________________________]                              │
│                                                              │
│ Подрядчик: *                                                 │
│ [_____________________________]                              │
│                                                              │
│ Технический заказчик (опционально):                          │
│ [_____________________________]                              │
│                                                              │
│ Период выполнения работ:                                     │
│ С: [01.01.2024] По: [31.12.2024]                            │
│                                                              │
│ Формат формирования комплекта ИД: *                          │
│ ○ Вариант 1: Документы качества к каждому АОСР              │
│   (удобно для поэтапной сдачи)                               │
│ ● Вариант 2: Документы качества в конце, со ссылками        │
│   (компактнее, подходит для сдачи всего объёма)             │
│                                                              │
│ Данные поставщика (для генерации отказных писем):            │
│                                                              │
│ Организация-поставщик:                                       │
│ [_____________________________]                              │
│                                                              │
│ ИНН:                                                         │
│ [_____________________________]                              │
│                                                              │
│ Адрес:                                                       │
│ [_____________________________]                              │
│                                                              │
│                          [Отмена]  [Создать проект]          │
└──────────────────────────────────────────────────────────────┘
```

### Что происходит в системе

1. Backend создаёт запись в таблице `projects`:
```sql
INSERT INTO projects (
  id,
  name,
  address,
  developer,
  general_contractor,
  contractor,
  technical_customer,
  start_date,
  end_date,
  package_format,
  supplier_info,
  created_at,
  status
) VALUES (
  gen_random_uuid(),
  'ЖК Солнечный, корпус 1',
  'г. Москва, ул. Строителей, д. 10',
  'ООО "Застройщик"',
  'ООО "Генподрядчик"',
  'ООО "Подрядчик"',
  'ООО "Техзаказчик"',
  '2024-01-01',
  '2024-12-31',
  'unified', -- 'repeated' или 'unified'
  '{"name": "ООО СтройМатериалы", "inn": "7701234567", "address": "Москва, ул. Строителей, 10"}',
  NOW(),
  'created'
);
```

2. Пользователь перенаправляется на страницу проекта

### Время выполнения
**~2-3 минуты** (заполнение формы)

---

## 2. Загрузка рабочей документации

### Цель
Загрузить PDF файлы рабочей документации (РД), которые будут проанализированы AI.

### Что делает пользователь

**Шаг 2.1: Открывает раздел "Документы"**

```
┌──────────────────────────────────────────────────────────────┐
│ 📂 Проект: ЖК Солнечный, корпус 1                           │
├──────────────────────────────────────────────────────────────┤
│ [Документы] [АОСР] [Документы качества] [Валидация] [Пакет] │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ 📁 Рабочая документация                                      │
│                                                              │
│ ⬆️  Перетащите файлы сюда или нажмите для выбора            │
│    Поддерживаются: PDF, максимум 100 МБ на файл             │
│                                                              │
│ [+ Выбрать файлы]                                            │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 2.2: Выбирает файлы**

Пользователь выбирает один или несколько PDF файлов:
- `01_Раздел_ОВ.pdf` (15 МБ, 45 страниц)
- `02_Раздел_ВК.pdf` (12 МБ, 38 страниц)
- `03_Схемы_исполнительные.pdf` (8 МБ, 12 страниц)

**Шаг 2.3: Наблюдает за процессом загрузки**

```
┌──────────────────────────────────────────────────────────────┐
│ Загрузка документов                                          │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✓ 01_Раздел_ОВ.pdf                                          │
│   15 МБ | 45 страниц | Обрабатывается... 60%                │
│   [████████████░░░░░░░░]                                     │
│                                                              │
│ ⏳ 02_Раздел_ВК.pdf                                          │
│   12 МБ | 38 страниц | Ожидание...                          │
│   [░░░░░░░░░░░░░░░░░░░░]                                     │
│                                                              │
│ ⏳ 03_Схемы_исполнительные.pdf                               │
│   8 МБ | 12 страниц | Ожидание...                           │
│   [░░░░░░░░░░░░░░░░░░░░]                                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 2.4: Получает уведомление о завершении**

```
┌──────────────────────────────────────────────────────────────┐
│ ✅ Все документы обработаны!                                 │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✓ 01_Раздел_ОВ.pdf - извлечено 50,000 символов              │
│ ✓ 02_Раздел_ВК.pdf - извлечено 42,000 символов              │
│ ✓ 03_Схемы_исполнительные.pdf - извлечено 5,000 символов    │
│                                                              │
│ [Перейти к анализу РД →]                                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### Что происходит в системе

Для каждого файла:

1. **Загрузка в Object Storage**
2. **OCR через GPT-5.2 Vision** (извлечение текста)
3. **Сохранение в БД**:
```sql
INSERT INTO documents (
  id,
  project_id,
  file_name,
  file_url,
  file_size,
  page_count,
  doc_type,
  extracted_text,
  status
) VALUES (
  'doc_123',
  'project_1',
  '01_Раздел_ОВ.pdf',
  's3://bucket/project_1/documents/doc_123.pdf',
  15728640, -- 15 МБ
  45,
  'РД',
  '[50000 символов текста...]',
  'analyzed'
);
```

### Время выполнения
**~5-10 минут** (зависит от количества и размера файлов)

---

## 3. Анализ РД и выбор шаблонов

### Цель
AI анализирует загруженные документы, извлекает виды работ и материалы. Пользователь **выбирает шаблоны** для генерации документов.

### Что делает пользователь

**Шаг 3.1: Выбор шаблонов для генерации документов**

После загрузки РД система **сразу предлагает выбрать шаблоны** (до анализа):

```
┌──────────────────────────────────────────────────────────────┐
│ 📋 Выбор шаблонов для генерации документов                   │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ Для генерации исполнительной документации необходимо         │
│ выбрать шаблоны форм.                                        │
│                                                              │
│ 1️⃣ Шаблон общего реестра ИД:                               │
│                                                              │
│ ○ Стандартный шаблон (по ГОСТ)                               │
│ ● Загрузить свой шаблон                                      │
│   [📎 04_Шаблон общего реестра.xlsx] [Изменить]            │
│                                                              │
│ 2️⃣ Шаблон реестра документов качества к АОСР:              │
│                                                              │
│ ○ Стандартный шаблон                                         │
│ ● Загрузить свой шаблон                                      │
│   [📎 04_Шаблон реестра к АОСР.xlsx] [Изменить]            │
│                                                              │
│ 3️⃣ Форма АОСР:                                              │
│                                                              │
│ ○ Стандартная форма АОСР                                     │
│ ● Загрузить свою форму                                       │
│   [📎 04_Форма АОСР.xlsx] [Изменить]                        │
│                                                              │
│ ℹ️  Шаблоны должны быть в формате Excel (.xlsx)             │
│                                                              │
│ [Отмена]  [Продолжить к анализу РД →]                        │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Важно:** Выбранные шаблоны сохраняются в `project.custom_templates`:
```json
{
  "general_registry": "storage/projects/123/templates/04_Шаблон общего реестра.xlsx",
  "quality_registry": "storage/projects/123/templates/04_Шаблон реестра к АОСР.xlsx",
  "aosr_form": "storage/projects/123/templates/04_Форма АОСР.xlsx"
}
```

**Шаг 3.2: Запускает анализ РД**

После выбора шаблонов пользователь нажимает кнопку:

```
┌──────────────────────────────────────────────────────────────┐
│ 🔍 Анализ рабочей документации                               │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ AI проанализирует загруженные документы и извлечёт:          │
│ • Виды работ (с объёмами, ГОСТами)                           │
│ • Материалы (производители, характеристики)                  │
│ • Схемы и чертежи                                            │
│                                                              │
│ Это займёт ~2-5 минут.                                       │
│                                                              │
│ [Запустить анализ]                                           │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 3.3: Ожидает завершения анализа**

```
┌──────────────────────────────────────────────────────────────┐
│ ⏳ Анализ в процессе...                                      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✓ 01_Раздел_ОВ.pdf - анализ завершён                        │
│   Найдено: 12 видов работ, 45 материалов                    │
│                                                              │
│ ⏳ 02_Раздел_ВК.pdf - анализируется... 70%                   │
│   [██████████████░░░░░░]                                     │
│                                                              │
│ ⏳ 03_Схемы_исполнительные.pdf - ожидание...                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 3.4: Проверяет результаты анализа**

```
┌──────────────────────────────────────────────────────────────┐
│ ✅ Анализ завершён!                                          │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ 📊 Результаты:                                               │
│                                                              │
│ Виды работ: 18                                               │
│ • Монтаж системы отопления (150 м²)                          │
│ • Монтаж системы водоснабжения (120 м²)                      │
│ • Устройство канализации (100 м²)                            │
│ • ... ещё 15 видов                                           │
│                                                              │
│ Материалы: 67                                                │
│ • Труба REHAU RAUTITAN stabil d=20мм (500 м)                │
│ • Фитинг REHAU угловой 20мм (50 шт)                         │
│ • Клапан термостатический Danfoss RA-N 15 (20 шт)           │
│ • ... ещё 64 материала                                       │
│                                                              │
│ [Перейти к поиску документов качества →]                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### Что происходит в системе

1. **Загрузка шаблонов в Object Storage**
2. **Сохранение путей к шаблонам в БД**:
```sql
UPDATE projects
SET custom_templates = '{
  "general_registry": "storage/projects/123/templates/04_Шаблон общего реестра.xlsx",
  "quality_registry": "storage/projects/123/templates/04_Шаблон реестра к АОСР.xlsx",
  "aosr_form": "storage/projects/123/templates/04_Форма АОСР.xlsx"
}'
WHERE id = 'project_123';
```

3. **RD Analyzer Agent** обрабатывает каждый документ
4. **GPT-5.2 Instant** извлекает структурированные данные
5. **Сохранение в БД**:
```sql
-- Виды работ
INSERT INTO work_types (id, project_id, name, volume, unit, gost, ...);

-- Материалы
INSERT INTO materials (id, project_id, name, manufacturer, quantity, unit, ...);
```

### Время выполнения
**~5-10 минут** (зависит от объёма РД)

---

## 4. Поиск документов качества

### Цель
Найти документы качества (сертификаты, паспорта) для всех материалов. Процесс **полуавтоматический** с участием пользователя.

### Что делает пользователь

**Шаг 4.1: Просматривает результаты автоматического поиска**

Система автоматически проверяет **базу данных** и **специализированные сайты**:

```
┌──────────────────────────────────────────────────────────────┐
│ 🔎 Поиск документов качества                                 │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✅ Найдено в базе (7 документов):                            │
│   • Труба REHAU d=16мм - Сертификат №С-RU.АГ76.В.03581      │
│   • Фитинг REHAU угловой - Паспорт качества                  │
│   • ... (ещё 5)                                              │
│                                                              │
│ ⚠️ НЕ НАЙДЕНО (8 документов):                                │
│                                                              │
│   [✓] Труба REHAU d=20мм                                     │
│   [✓] Труба REHAU d=25мм                                     │
│   [✓] Клапан термостатический Danfoss RA-N 15                │
│   [ ] Утеплитель Rockwool 50мм                               │
│   [✓] Краска Tikkurila белая                                 │
│   [ ] Грунтовка ГФ-021                                       │
│   [✓] Крепёж дюбель 6x40                                     │
│   [ ] Лента уплотнительная ФУМ                               │
│                                                              │
│ 5 из 8 выбрано                                               │
│                                                              │
│ [Искать выбранные в интернете (5)]  [Выбрать все]            │
│ [Я загружу вручную позже]           [Снять все]              │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 4.2: Выбирает материалы для поиска в интернете**

Пользователь отмечает галочками материалы, для которых нужно искать документы в Google.

**Шаг 4.3: Запускает поиск в интернете**

```
┌──────────────────────────────────────────────────────────────┐
│ 🌐 Поиск в интернете (5 материалов)                          │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ⏳ Поиск 2 из 5...                                           │
│                                                              │
│ ✓ Труба REHAU d=20мм                                         │
│   Найдено: Сертификат №С-RU.АГ76.В.03582 (santech.ru)       │
│                                                              │
│ ✓ Труба REHAU d=25мм                                         │
│   Найдено: Сертификат №С-RU.АГ76.В.03582 (Google)           │
│                                                              │
│ ⏳ Клапан термостатический Danfoss RA-N 15                   │
│   Поиск на danfoss.ru...                                     │
│                                                              │
│ ⏳ Краска Tikkurila белая                                    │
│   Ожидание...                                                │
│                                                              │
│ ⏳ Крепёж дюбель 6x40                                        │
│   Ожидание...                                                │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 4.4: Просматривает результаты поиска**

```
┌──────────────────────────────────────────────────────────────┐
│ 📊 Результаты поиска в интернете                             │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✅ Найдено (3 документа):                                    │
│   • Труба REHAU d=20мм - Сертификат (santech.ru)             │
│   • Труба REHAU d=25мм - Сертификат (Google)                 │
│   • Краска Tikkurila - Сертификат + СРГ (tikkurila.ru)       │
│                                                              │
│ ❌ Не найдено (2 документа):                                 │
│   [✓] Клапан термостатический Danfoss RA-N 15                │
│   [✓] Крепёж дюбель 6x40                                     │
│                                                              │
│ 🔄 Пропущено ранее (3 документа):                            │
│   • Утеплитель Rockwool 50мм                                 │
│   • Грунтовка ГФ-021                                         │
│   • Лента уплотнительная ФУМ                                 │
│                                                              │
│ Что делать с не найденными (5 материалов)?                   │
│                                                              │
│ [Сгенерировать AI для выбранных (2)]                         │
│ [Я загружу вручную позже]                                    │
│ [Выбрать все 5]  [Снять все]                                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 4.5: Выбирает стратегию для недостающих документов**

Варианты:
1. **Сгенерировать AI** (если возможно)
2. **Загрузить вручную позже**
3. **Пропустить** (можно добавить позже)

### Что происходит в системе

1. **Quality Document Search Agent** ищет в базе
2. **Параллельный поиск** на специализированных сайтах
3. **Google Search** для выбранных материалов
4. **GPT-5.2 Instant валидирует** найденные документы
5. **Сохранение в БД**:
```sql
INSERT INTO quality_documents (
  id, material_id, document_type, file_url, source, confidence
) VALUES (
  'qd_1', 'mat_1', 'Сертификат', 's3://...',
  'специализированный сайт (santech.ru)', 0.95
);
```

### Время выполнения
**~10-15 минут** (зависит от количества материалов и участия пользователя)

---

## 5. Генерация АОСР

### Цель
Автоматически сгенерировать АОСР для всех видов работ.

### Что делает пользователь

**Шаг 5.1: Нажимает "Сгенерировать АОСР"**

```
┌──────────────────────────────────────────────────────────────┐
│ 📝 Генерация актов освидетельствования скрытых работ         │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ Будет сгенерировано 18 АОСР для:                             │
│ • Монтаж системы отопления (150 м²)                          │
│ • Монтаж системы водоснабжения (120 м²)                      │
│ • Устройство канализации (100 м²)                            │
│ • ... ещё 15 видов работ                                     │
│                                                              │
│ [Сгенерировать все АОСР]                                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 5.2: Наблюдает за процессом генерации**

```
┌──────────────────────────────────────────────────────────────┐
│ ⏳ Генерация АОСР (5 из 18)...                               │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✓ АОСР №01-КЖ6-1: Монтаж системы отопления                  │
│ ✓ АОСР №01-КЖ6-2: Монтаж системы водоснабжения              │
│ ✓ АОСР №01-КЖ6-3: Устройство канализации                    │
│ ✓ АОСР №01-КЖ6-4: Монтаж вентиляции                         │
│ ⏳ АОСР №01-КЖ6-5: Устройство теплоизоляции... 60%           │
│ ⏳ АОСР №01-КЖ6-6: Монтаж электрики - ожидание               │
│ ⏳ ... ещё 12 АОСР                                            │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 5.3: Получает уведомление о завершении**

```
┌──────────────────────────────────────────────────────────────┐
│ ✅ Все АОСР сгенерированы!                                   │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ Создано 18 актов в формате PDF.                             │
│                                                              │
│ [Перейти к проверке и редактированию →]                      │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### Что происходит в системе

1. **AOSR Generator Agent** для каждого вида работ:
   - Берёт данные из `work_types`, `materials`
   - Заполняет шаблон АОСР (выбранный на шаге 3.1)
   - Генерирует PDF через ReportLab
2. **Сохранение в БД и Object Storage**

### Время выполнения
**~3-5 минут** (для 18 АОСР)

---

## 6. Проверка и редактирование

### Цель
Проверить сгенерированные АОСР, отредактировать при необходимости, добавить подписи.

### Что делает пользователь

**Шаг 6.1: Просматривает список АОСР**

```
┌──────────────────────────────────────────────────────────────┐
│ 📋 Акты освидетельствования (18)                             │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ АОСР №01-КЖ6-1                                               │
│ Монтаж системы отопления | 150 м²                           │
│ Дата: 15.03.2024 | Статус: Черновик v1                      │
│ [👁️ Просмотр] [✏️ Редактировать] [✓ Утвердить]             │
│                                                              │
│ АОСР №01-КЖ6-2                                               │
│ Монтаж системы водоснабжения | 120 м²                       │
│ Дата: 20.03.2024 | Статус: Черновик v1                      │
│ [👁️ Просмотр] [✏️ Редактировать] [✓ Утвердить]             │
│                                                              │
│ ... ещё 16 АОСР                                              │
│                                                              │
│ [Утвердить все]  [Экспорт в Excel]                           │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 6.2: Редактирует АОСР (если нужно)**

```
┌──────────────────────────────────────────────────────────────┐
│ ✏️ Редактирование АОСР №01-КЖ6-1                             │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ Вид работ: [Монтаж системы отопления_____________]           │
│ Объём: [150] [м²▾]                                           │
│ Дата начала: [01.03.2024] Дата окончания: [15.03.2024]      │
│                                                              │
│ Материалы:                                                   │
│ • Труба REHAU d=20мм - 500 м ✓                               │
│ • Фитинг REHAU угловой - 50 шт ✓                             │
│ • [+ Добавить материал]                                      │
│                                                              │
│ Документы качества (3):                                      │
│ • Сертификат REHAU №С-RU... ✓                                │
│ • Паспорт качества партия 2024-03-150 ✓                      │
│ • [+ Добавить документ]                                      │
│                                                              │
│ Исполнительная схема:                                        │
│ [📎 Схема_отопление.pdf] [Заменить]                         │
│                                                              │
│ Подписи:                                                     │
│ Представитель подрядчика: [Иванов И.И._____]                 │
│ Представитель заказчика: [Петров П.П._____]                  │
│                                                              │
│ [Отмена]  [Сохранить]  [Сохранить и утвердить]               │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 6.3: Утверждает АОСР**

После проверки пользователь утверждает акты (по одному или все сразу).

### Что происходит в системе

1. **Обновление данных в БД**
2. **Создание новой версии** (если были изменения):
```sql
UPDATE aosr
SET version = 2, status = 'approved', approved_at = NOW()
WHERE id = 'aosr_1';
```
3. **Генерация новой версии PDF** (если были изменения)

### Время выполнения
**~10-30 минут** (зависит от необходимости редактирования)

---

## 7. Валидация комплекта

### Цель
Автоматически проверить комплект на полноту и корректность перед формированием финального пакета.

### Что делает пользователь

**Шаг 7.1: Запускает валидацию**

```
┌──────────────────────────────────────────────────────────────┐
│ ✓ Проверка комплекта                                         │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ Система проверит:                                            │
│ • Полноту документов (РД, АОСР, документы качества)          │
│ • Согласованность дат                                        │
│ • Соответствие материалов                                    │
│ • Наличие подписей                                           │
│ • Логическую целостность                                     │
│                                                              │
│ [Запустить проверку]                                         │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 7.2: Просматривает результаты валидации**

```
┌──────────────────────────────────────────────────────────────┐
│ 📊 Результаты валидации                                      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✅ Наличие документов: Пройдено                              │
│    Все обязательные документы на месте                       │
│                                                              │
│ ✅ Согласованность дат: Пройдено                             │
│    Все даты логичны и последовательны                        │
│                                                              │
│ ⚠️  Соответствие материалов: 1 предупреждение                │
│    • Материал "Труба d=32мм" не найден в документах качества │
│      → Рекомендация: добавить сертификат или отказное письмо │
│                                                              │
│ ✅ Полнота данных: Пройдено                                  │
│    Все поля заполнены, подписи на месте                      │
│                                                              │
│ ✅ Логическая целостность: Пройдено                          │
│    Объёмы и количества соответствуют нормам                  │
│                                                              │
│ Критические ошибки: 0                                        │
│ Предупреждения: 1                                            │
│                                                              │
│ Можно создавать финальный пакет: ✅ Да                        │
│                                                              │
│ [Исправить предупреждения]  [Создать пакет →]                │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### Что происходит в системе

1. **Validation Agent** выполняет 5 проверок
2. **Сохранение отчёта в БД**:
```sql
INSERT INTO validation_reports (project_id, status, results, ...);
```

### Время выполнения
**~1-2 минуты**

---

## 8. Формирование финального пакета

### Цель
Сформировать единый PDF и архив ZIP со всеми документами проекта.

### Что делает пользователь

**Шаг 8.1: Нажимает "Создать финальный пакет"**

```
┌──────────────────────────────────────────────────────────────┐
│ 📦 Формирование финального комплекта ИД                      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ Будет создано:                                               │
│                                                              │
│ 📄 Единый PDF файл (~45 МБ):                                 │
│    • Титульный лист                                          │
│    • Общий реестр ИД                                         │
│    • 18 АОСР с исполнительными схемами                       │
│    • 67 документов качества                                  │
│    • Реестры документов качества к АОСР                      │
│                                                              │
│ 📦 Архив ZIP (~50 МБ):                                       │
│    • PDF документы (в папках)                                │
│    • Редактируемые Excel файлы (АОСР, реестры)               │
│    • Рабочая документация                                    │
│    • Папка для геодезических схем (DWG)                      │
│                                                              │
│ Время формирования: ~2-3 минуты                              │
│                                                              │
│ [Создать пакет]                                              │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 8.2: Ожидает завершения**

```
┌──────────────────────────────────────────────────────────────┐
│ ⏳ Формирование пакета... 50%                                │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✓ Сбор метаданных                                            │
│ ✓ Генерация титульного листа                                 │
│ ✓ Генерация общего реестра                                   │
│ ⏳ Объединение PDF документов... 9/18 АОСР                   │
│ ⏳ Создание архива ZIP - ожидание                            │
│ ⏳ Загрузка в облако - ожидание                              │
│                                                              │
│ [████████████░░░░░░░░]                                       │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Шаг 8.3: Скачивает готовые файлы**

```
┌──────────────────────────────────────────────────────────────┐
│ ✅ Финальный пакет готов!                                    │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ 📄 ИД_Проект_ЖК_Солнечный_полный_комплект.pdf               │
│    45.2 МБ | 152 страницы                                    │
│    [⬇️ Скачать PDF]                                          │
│                                                              │
│ 📦 ИД_Архив_Проект_ЖК_Солнечный.zip                          │
│    52.8 МБ                                                   │
│    [⬇️ Скачать архив]                                        │
│                                                              │
│ Ссылки действительны 7 дней.                                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### Что происходит в системе

1. **Package Builder Agent** собирает все файлы
2. **Генерация титульника и реестра** (используя выбранные шаблоны из шага 3.1)
3. **Объединение PDF** с помощью PyPDF2
4. **Создание ZIP архива**
5. **Загрузка в Object Storage**
6. **Генерация временных ссылок** на скачивание

### Время выполнения
**~2-5 минут** (зависит от размера комплекта)

---

## Временные оценки

### Итоговое время от начала до конца

| Этап | Минимум | Максимум | Среднее |
|------|---------|----------|---------|
| 1. Создание проекта | 2 мин | 5 мин | 3 мин |
| 2. Загрузка РД | 5 мин | 15 мин | 10 мин |
| 3. Анализ РД + выбор шаблонов | 5 мин | 15 мин | 10 мин |
| 4. Поиск документов качества | 10 мин | 30 мин | 20 мин |
| 5. Генерация АОСР | 3 мин | 10 мин | 5 мин |
| 6. Проверка и редактирование | 10 мин | 60 мин | 30 мин |
| 7. Валидация | 1 мин | 3 мин | 2 мин |
| 8. Финальный пакет | 2 мин | 10 мин | 5 мин |
| **ИТОГО** | **38 мин** | **148 мин** | **85 мин (~1.5 часа)** |

### Сравнение с ручной работой

| Задача | Ручная работа | С платформой | Экономия времени |
|--------|---------------|--------------|------------------|
| Анализ РД | ~8 часов | ~10 минут | **98% быстрее** |
| Поиск документов качества | ~16 часов | ~20 минут | **98% быстрее** |
| Создание АОСР | ~24 часа | ~5 минут | **99% быстрее** |
| Формирование пакета | ~8 часов | ~5 минут | **98% быстрее** |
| **ИТОГО** | **~7 дней** | **~1.5 часа** | **99% быстрее** |

---

## Связь с другими документами

- [01-how-it-works.md](01-how-it-works.md) — общая архитектура платформы
- [03-agents-interaction.md](03-agents-interaction.md) — взаимодействие AI-агентов на каждом этапе
- [08-batch-document-search.md](08-batch-document-search.md) — детали пакетного поиска (шаг 4)
- [09-document-priorities-dependencies.md](09-document-priorities-dependencies.md) — логика поиска документов (шаг 4)
- [10-final-package-generation.md](10-final-package-generation.md) — детали генерации финального пакета (шаг 8)

---

**Статус:** ✅ Готово к реализации
**Последнее обновление:** 2025-12-15
