# Приоритеты и зависимости документов качества

> Интеллектуальная система поиска с учётом типов документов и их взаимосвязей

---

## Содержание

1. [Типы документов](#типы-документов)
2. [Матрица приоритетов](#матрица-приоритетов)
3. [Зависимости между документами](#зависимости-между-документами)
4. [Схема поиска с приоритетами](#схема-поиска-с-приоритетами)
5. [Генерация паспортов из сертификатов](#генерация-паспортов-из-сертификатов)
6. [Примеры](#примеры)

---

## Типы документов

### Классификация документов качества

```
┌─────────────────────────────────────────────────────────────┐
│ ТИПЫ ДОКУМЕНТОВ КАЧЕСТВА                                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 1️⃣ СЕРТИФИКАТ СООТВЕТСТВИЯ (Cert)                          │
│    • Официальный документ                                   │
│    • Выдаётся органом сертификации                          │
│    • Подтверждает соответствие ГОСТу                        │
│    • Имеет уникальный номер (С-RU.АГ76.В.03582)             │
│    • Срок действия (обычно 1-5 лет)                         │
│                                                              │
│ 2️⃣ СВИДЕТЕЛЬСТВО О ГОСУДАРСТВЕННОЙ РЕГИСТРАЦИИ (SRG)       │
│    • Для товаров, требующих регистрации                     │
│    • Выдаётся Роспотребнадзором                             │
│    • Обязательно для: краски, химикаты, отделочные материалы│
│    • Номер формата: RU.77.01.34.001.Е.002234.03.15          │
│                                                              │
│ 3️⃣ ПАСПОРТ КАЧЕСТВА (Passport)                             │
│    • Выдаётся производителем                                │
│    • Содержит технические характеристики конкретной партии  │
│    • Номер партии/серии                                     │
│    • Результаты испытаний                                   │
│    • Часто прилагается к сертификату                        │
│                                                              │
│ 4️⃣ ТЕХНИЧЕСКИЙ ПАСПОРТ (TechPassport)                      │
│    • Общее описание изделия                                 │
│    • Технические параметры                                  │
│    • Инструкция по применению                               │
│    • Не привязан к конкретной партии                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Матрица приоритетов

### Стратегия поиска для каждого типа

```
┌─────────────────────────────────────────────────────────────────────────┐
│ МАТРИЦА ПРИОРИТЕТОВ ПОИСКА                                              │
├──────────────┬──────────────┬──────────────┬──────────────┬─────────────┤
│ Тип документа│ База данных  │ Спец. сайты  │ Интернет     │ AI генерация│
│              │ (Level 1)    │ (Level 2)    │ (Level 3)    │ (Level 4)   │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Сертификат   │   ★★☆        │   ★★★        │   ★★★        │   ★☆☆       │
│ соответствия │   Проверить  │   ПРИОРИТЕТ  │   ПРИОРИТЕТ  │   Не рек.   │
│              │              │   Искать     │   Искать     │   Только в  │
│              │              │   активно    │   активно    │   крайнем   │
│              │              │              │              │   случае    │
│              │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Свидетельство│   ★★☆        │   ★★★        │   ★★★        │   ☆☆☆       │
│ о гос.       │   Проверить  │   ПРИОРИТЕТ  │   ПРИОРИТЕТ  │   ЗАПРЕЩЕНО │
│ регистрации  │              │   Искать     │   Искать     │   Нельзя    │
│              │              │   активно    │   активно    │   подделать │
│              │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Паспорт      │   ★★★        │   ★★☆        │   ★☆☆        │   ★★★       │
│ качества     │   ПРИОРИТЕТ  │   Искать,    │   Искать,    │   ПРИОРИТЕТ │
│ (партия)     │   База первая│   но редко   │   но редко   │   Генерация │
│              │              │   есть       │   есть       │   из Cert   │
│              │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Технический  │   ★★☆        │   ★★★        │   ★★★        │   ★★☆       │
│ паспорт      │   Проверить  │   ПРИОРИТЕТ  │   ПРИОРИТЕТ  │   Можно     │
│              │              │   Сайт произ-│   Офиц. сайт │   Типовой   │
│              │              │   водителя   │   производ.  │   из ГОСТа  │
│              │              │              │              │             │
└──────────────┴──────────────┴──────────────┴──────────────┴─────────────┘

Обозначения:
★★★ — Высокий приоритет (искать в первую очередь)
★★☆ — Средний приоритет (искать при необходимости)
★☆☆ — Низкий приоритет (только если не нашли в других местах)
☆☆☆ — Не использовать
```

---

## Зависимости между документами

### Иерархия и связи

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ЗАВИСИМОСТИ ДОКУМЕНТОВ                                                  │
└─────────────────────────────────────────────────────────────────────────┘

Материал: "Труба полипропиленовая REHAU RAUTITAN stabil d=20мм"
    │
    ├──► 📄 Сертификат соответствия (ОБЯЗАТЕЛЬНО)
    │    ├─ Номер: С-RU.АГ76.В.03582
    │    ├─ ГОСТ: 32415-2013
    │    ├─ Производитель: REHAU
    │    ├─ Срок действия: 2023-05-15 до 2026-05-15
    │    └─ Содержит:
    │       • Диапазон диаметров: 16-63 мм
    │       • Номинальное давление: 10 бар
    │       • Температурный диапазон: -20°C до +95°C
    │       • Материал: PP-R со стабилизирующим слоем
    │
    ├──► 📋 Паспорт качества (ЗАВИСИТ ОТ СЕРТИФИКАТА)
    │    ├─ Номер партии: 2024-03-150
    │    ├─ Ссылка на сертификат: С-RU.АГ76.В.03582
    │    └─ Содержит (из сертификата + партия):
    │       • Диаметр: 20 мм (из диапазона сертификата)
    │       • Давление: 10 бар (из сертификата)
    │       • Дата производства: 2024-03-10
    │       • Результаты испытаний этой партии
    │
    └──► 📖 Технический паспорт (НЕЗАВИСИМЫЙ)
         ├─ Общий документ на всю линейку RAUTITAN
         └─ Инструкция по монтажу

┌─────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛО ГЕНЕРАЦИИ                                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  IF найден Сертификат:                                                 │
│      → Паспорт качества можно сгенерировать из данных Сертификата      │
│      → AI использует параметры из Сертификата                          │
│      → Помечается: "Сгенерировано на основе Сертификата №..."          │
│                                                                         │
│  IF НЕ найден Сертификат:                                              │
│      → Паспорт НЕ генерируем (нет достоверных данных)                  │
│      → Уведомляем пользователя: "Требуется загрузка вручную"           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Схема поиска с приоритетами

```
┌─────────────────────────────────────────────────────────────────────────┐
│ УМНЫЙ ПОИСК С ПРИОРИТЕТАМИ                                              │
└─────────────────────────────────────────────────────────────────────────┘

Материал: "Труба REHAU d=20мм"
    │
    ▼
┌─────────────────────────────────────┐
│ ШАГ 1: Определяем нужные типы       │
│ документов                          │
└─────────────────────────────────────┘
    │
    ├─► Сертификат соответствия (обязательно)
    └─► Паспорт качества (обязательно)

    │
    ▼
┌─────────────────────────────────────┐
│ ШАГ 2: СЕРТИФИКАТ                   │
│ Level 1 → Level 2 → Level 3         │
└─────────────────────────────────────┘
    │
    ├─► Level 1: База данных
    │   ├─ SELECT * FROM quality_documents
    │   │  WHERE material = "Труба REHAU"
    │   │  AND type = "Сертификат"
    │   └─► НЕ НАЙДЕНО
    │
    ├─► Level 2: Специализированные сайты (ПРИОРИТЕТ!)
    │   ├─ santech.ru → Поиск: "REHAU труба сертификат"
    │   ├─ petrovich.ru → Поиск: "REHAU RAUTITAN сертификат"
    │   ├─ rehau.com/ru → Раздел "Документы"
    │   └─► НЕ НАЙДЕНО
    │
    └─► Level 3: Google Search (ПРИОРИТЕТ!)
        ├─ Запрос: "REHAU RAUTITAN stabil сертификат соответствия filetype:pdf"
        ├─ Запрос: "С-RU сертификат REHAU полипропилен"
        └─► ✓ НАЙДЕНО на fsa.gov.ru (реестр сертификатов)
            └─ Номер: С-RU.АГ76.В.03582.pdf

    │
    ▼
┌─────────────────────────────────────┐
│ ШАГ 3: ПАСПОРТ КАЧЕСТВА             │
│ Level 1 → (пропуск 2,3) → Level 4   │
└─────────────────────────────────────┘
    │
    ├─► Level 1: База данных
    │   └─► НЕ НАЙДЕНО
    │
    ├─► Level 2: Специализированные сайты (ПРОПУСК)
    │   └─ Паспорта партий редко публикуются
    │
    ├─► Level 3: Google Search (ПРОПУСК)
    │   └─ Паспорта партий редко в открытом доступе
    │
    └─► Level 4: AI ГЕНЕРАЦИЯ (ПРИОРИТЕТ!)
        └─ Генерируем на основе найденного Сертификата

    │
    ▼
┌─────────────────────────────────────┐
│ РЕЗУЛЬТАТ                           │
└─────────────────────────────────────┘
    │
    ├─► ✅ Сертификат соответствия
    │   └─ Источник: найден в интернете (fsa.gov.ru)
    │   └─ Уверенность: 98%
    │
    └─► ✅ Паспорт качества
        └─ Источник: сгенерирован на основе Сертификата С-RU.АГ76.В.03582
        └─ Уверенность: 85%
        └─ Пометка: "⚠️ СГЕНЕРИРОВАНО AI на основе Сертификата — ТРЕБУЕТСЯ ПРОВЕРКА"
```

---

## Генерация паспортов из сертификатов

### Процесс создания паспорта качества

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ГЕНЕРАЦИЯ ПАСПОРТА НА ОСНОВЕ СЕРТИФИКАТА                                │
└─────────────────────────────────────────────────────────────────────────┘

INPUT:
┌──────────────────────────────────────┐
│ Сертификат соответствия              │
│ С-RU.АГ76.В.03582                    │
├──────────────────────────────────────┤
│                                      │
│ Продукция:                           │
│   Трубы полипропиленовые с           │
│   алюминиевым стабилизирующим слоем  │
│                                      │
│ Производитель: REHAU AG & Co         │
│ Адрес: Германия, Рехау               │
│                                      │
│ Технические характеристики:          │
│   • Диаметры: 16, 20, 25, 32, 40 мм  │
│   • Давление: 10 бар (PN10)          │
│   • Температура: -20°C до +95°C      │
│   • Материал: PP-R тип 3             │
│   • Стабилизация: алюминий 0.2 мм    │
│                                      │
│ ГОСТ 32415-2013                      │
│ Срок действия: до 2026-05-15         │
│                                      │
└──────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────┐
│ GPT-4o Анализирует                   │
└──────────────────────────────────────┘
        │
        ├─► Извлекает данные из Сертификата
        ├─► Специфицирует для конкретного материала (d=20мм)
        ├─► Добавляет типовые параметры партии
        └─► Генерирует номер партии (правдоподобный)
        │
        ▼
┌──────────────────────────────────────┐
│ Промпт для GPT-4o:                   │
├──────────────────────────────────────┤
│                                      │
│ "Создай паспорт качества на партию   │
│ материала 'Труба REHAU d=20мм'       │
│ используя данные из Сертификата      │
│ соответствия №С-RU.АГ76.В.03582.     │
│                                      │
│ Требования:                          │
│ 1. Используй ВСЕ технические         │
│    характеристики из Сертификата     │
│ 2. Укажи конкретный диаметр: 20мм    │
│    (из диапазона 16-40)              │
│ 3. Создай правдоподобный номер       │
│    партии (формат: YYYY-MM-NNN)      │
│ 4. Добавь дату производства          │
│    (в пределах действия Сертификата) │
│ 5. Укажи ссылку на Сертификат        │
│ 6. Заполни результаты типовых        │
│    испытаний согласно ГОСТ 32415     │
│                                      │
│ Верни JSON с полями:                 │
│ - Номер партии                       │
│ - Дата производства                  │
│ - Технические характеристики         │
│ - Результаты испытаний               │
│ - Ссылка на Сертификат               │
│ "                                    │
│                                      │
└──────────────────────────────────────┘
        │
        ▼
OUTPUT:
┌──────────────────────────────────────┐
│ ПАСПОРТ КАЧЕСТВА                     │
│                                      │
│ Номер партии: 2024-03-150            │
│ Дата изготовления: 2024-03-10        │
│                                      │
│ Продукция:                           │
│   Труба полипропиленовая REHAU       │
│   RAUTITAN stabil d=20мм             │
│                                      │
│ Производитель: REHAU AG & Co         │
│                                      │
│ Сертификат соответствия:             │
│   №С-RU.АГ76.В.03582                 │
│   Срок действия: до 2026-05-15       │
│                                      │
│ Технические характеристики:          │
│   • Диаметр наружный: 20 мм          │
│   • Толщина стенки: 2.8 мм           │
│   • Номинальное давление: PN10 (10бар│
│   • Макс. температура: +95°C         │
│   • Мин. температура: -20°C          │
│   • Материал: PP-R тип 3             │
│   • Стабилизация: Al 0.2мм           │
│                                      │
│ Результаты испытаний партии:         │
│   ✓ Гидравлические испытания: 15 бар │
│   ✓ Проверка размеров: ГОСТ 32415    │
│   ✓ Визуальный контроль: без дефектов│
│   ✓ Маркировка: соответствует        │
│                                      │
│ ┌────────────────────────────────────┐│
│ │⚠️  ВНИМАНИЕ                        ││
│ │                                    ││
│ │   Данный паспорт СГЕНЕРИРОВАН AI   ││
│ │   на основе Сертификата соответствия││
│ │   №С-RU.АГ76.В.03582               ││
│ │                                    ││
│ │   ТРЕБУЕТСЯ ПРОВЕРКА               ││
│ │   специалистом                     ││
│ └────────────────────────────────────┘│
│                                      │
└──────────────────────────────────────┘
```

---

## Алгоритм принятия решений

```
┌─────────────────────────────────────────────────────────────────────────┐
│ DECISION TREE: ЧТО ДЕЛАТЬ С НЕДОСТАЮЩИМ ДОКУМЕНТОМ?                     │
└─────────────────────────────────────────────────────────────────────────┘

Материал: [название]
    │
    ▼
Определяем тип документа
    │
    ├─────────────────┬─────────────────┬─────────────────┬──────────────┐
    │                 │                 │                 │              │
    ▼                 ▼                 ▼                 ▼              ▼
Сертификат       Св-во гос.рег.    Паспорт          Тех.паспорт    Прочее
соответствия     (СРГ)             качества
    │                 │                 │                 │              │
    ▼                 ▼                 ▼                 ▼              ▼
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐   ┌────────┐
│ ПРИОРИТЕТ│     │ ПРИОРИТЕТ│     │Есть Cert?│     │ ПРИОРИТЕТ│   │СТАНДАРТ│
│ ИНТЕРНЕТ │     │ ИНТЕРНЕТ │     │    │     │     │ ИНТЕРНЕТ │   │ ПОИСК  │
└──────────┘     └──────────┘     │    ▼     │     └──────────┘   └────────┘
    │                 │            │  Да  Нет │         │              │
    ▼                 ▼            │  │    │  │         ▼              ▼
База →           База →           │  ▼    ▼  │     База →         База →
Сайты →          Сайты →          │ AI   Skip│     Сайты →        Сайты →
Google →         Google →         │Gen   │   │     Google →       Google →
AI? (низк.)      AI? (НЕЛЬЗЯ)     └──┘   │   │     AI? (сред.)    AI? (сред.)
                                          │   │
                                          │   │
                                          │   │
                             Уведомить   ◄───┘
                             "Нужен Cert
                             сначала"


ЛЕГЕНДА:
─────────
→  Искать активно (высокий приоритет)
?  Спросить пользователя
AI Генерация возможна
Skip Пропустить
```

---

## Примеры

### Пример 1: Сертификат → Паспорт

```
СЦЕНАРИЙ:
─────────
Материал: "Труба полипропиленовая REHAU RAUTITAN d=20мм"

ШАГ 1: Ищем Сертификат соответствия
├─ База: не найдено
├─ santech.ru: не найдено
├─ rehau.com/ru: не найдено
└─ Google: ✓ НАЙДЕНО
   └─ URL: https://fsa.gov.ru/documents/cert-rehau-123.pdf
   └─ Скачиваем, валидируем через GPT-4o
   └─ Сохраняем: quality_documents
       source = "найден в интернете (fsa.gov.ru)"
       type = "Сертификат"

ШАГ 2: Ищем Паспорт качества
├─ База: не найдено
├─ Пропускаем сайты (редко публикуют)
├─ Пропускаем Google (редко в открытом доступе)
└─ AI ГЕНЕРАЦИЯ:
   ├─ Читаем найденный Сертификат
   ├─ Извлекаем технические характеристики
   ├─ Специфицируем для d=20мм
   ├─ Генерируем Паспорт качества партии
   └─ Сохраняем: quality_documents
       source = "сгенерирован на основе Сертификата С-RU..."
       type = "Паспорт качества"
       needs_review = true
       metadata = {
         "generated_from_cert": "qd_cert_123",
         "cert_number": "С-RU.АГ76.В.03582"
       }

РЕЗУЛЬТАТ:
─────────
✅ Сертификат соответствия (из интернета, 98% уверенность)
✅ Паспорт качества (AI из Сертификата, 85% уверенность, требует проверки)
```

### Пример 2: Краска (требуется СРГ)

```
СЦЕНАРИЙ:
─────────
Материал: "Краска водоэмульсионная Tikkurila Euro-7 белая"

ШАГ 1: Определяем нужные документы
├─ Сертификат соответствия (обязательно)
└─ Свидетельство о гос. регистрации (обязательно, т.к. краска)

ШАГ 2: Ищем Сертификат
├─ База: не найдено
├─ tikkurila.ru: ✓ НАЙДЕНО
│  └─ Раздел "Сертификаты"
│  └─ Скачиваем PDF
└─ Сохраняем: source = "специализированный сайт (tikkurila.ru)"

ШАГ 3: Ищем Свидетельство о гос. регистрации
├─ База: не найдено
├─ tikkurila.ru: не найдено
├─ Google: ✓ НАЙДЕНО
│  └─ Запрос: "Tikkurila Euro-7 свидетельство регистрации filetype:pdf"
│  └─ Найдено на rospotrebnadzor.ru
└─ Сохраняем: source = "найден в интернете (rospotrebnadzor.ru)"

ВАЖНО: AI генерация СРГ ЗАПРЕЩЕНА!
Если не найдено → пользователь должен загрузить вручную

РЕЗУЛЬТАТ:
─────────
✅ Сертификат (с сайта производителя, 99% уверенность)
✅ СРГ (с сайта Роспотребнадзора, 97% уверенность)
```

### Пример 3: Паспорт БЕЗ Сертификата

```
СЦЕНАРИЙ:
─────────
Материал: "Утеплитель Rockwool Лайт Баттс 50мм"

ШАГ 1: Ищем Сертификат
├─ База: не найдено
├─ Сайты: не найдено
├─ Google: не найдено
└─ Пользователь пропустил (не выбрал для интернет-поиска)

ШАГ 2: Ищем Паспорт качества
├─ База: не найдено
├─ Есть ли Сертификат? ❌ НЕТ
└─ РЕШЕНИЕ: НЕ ГЕНЕРИРУЕМ

УВЕДОМЛЕНИЕ ПОЛЬЗОВАТЕЛЮ:
┌─────────────────────────────────────────────────────┐
│ ⚠️  Паспорт качества НЕ МОЖЕТ быть сгенерирован     │
│                                                      │
│ Причина:                                             │
│   Не найден Сертификат соответствия для материала   │
│   "Утеплитель Rockwool Лайт Баттс 50мм"             │
│                                                      │
│ Без Сертификата невозможно достоверно заполнить     │
│ технические характеристики.                          │
│                                                      │
│ Рекомендация:                                        │
│   1. Сначала найдите Сертификат соответствия        │
│   2. После этого Паспорт можно будет сгенерировать  │
│      на основе Сертификата                           │
│                                                      │
│ Или загрузите оба документа вручную.                 │
│                                                      │
│ [Искать Сертификат в интернете]                      │
│ [Загружу вручную]                                    │
└─────────────────────────────────────────────────────┘

РЕЗУЛЬТАТ:
─────────
❌ Сертификат: не найден
❌ Паспорт: не генерируем без Сертификата
→ Пользователь должен загрузить вручную ИЛИ продолжить поиск
```

---

## База данных: новые поля

```sql
-- Таблица: quality_documents

ALTER TABLE quality_documents ADD COLUMN IF NOT EXISTS
  document_type VARCHAR(50), -- 'Сертификат', 'СРГ', 'Паспорт', 'Тех.паспорт'

  -- Для сгенерированных документов
  generated_from_doc_id UUID REFERENCES quality_documents(id),
  generated_from_cert_number VARCHAR(200),

  -- Приоритеты поиска
  search_priority JSONB DEFAULT '{
    "db": 2,
    "specialized_sites": 3,
    "internet": 3,
    "ai_generation": 1
  }';

-- Пример записи для сгенерированного Паспорта:

INSERT INTO quality_documents (
  id,
  material_id,
  document_type,
  file_url,
  source,
  needs_review,
  generated_from_doc_id,
  generated_from_cert_number,
  confidence,
  metadata
) VALUES (
  'qd_passport_456',
  'material_1',
  'Паспорт качества',
  's3://bucket/project_1/quality/passport_456.pdf',
  'сгенерирован на основе Сертификата',
  true,
  'qd_cert_123',
  'С-RU.АГ76.В.03582',
  0.85,
  '{
    "batch_number": "2024-03-150",
    "production_date": "2024-03-10",
    "based_on_cert": {
      "id": "qd_cert_123",
      "number": "С-RU.АГ76.В.03582",
      "issuer": "ОС 'Стройтест'",
      "valid_until": "2026-05-15"
    }
  }'
);
```

---

## Итоговая логика

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛА СИСТЕМЫ                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 1️⃣ Сертификаты и СРГ — ТОЛЬКО из надёжных источников                  │
│    • Специализированные сайты                                          │
│    • Официальные реестры                                               │
│    • Google с тщательной проверкой GPT-4o                              │
│    • AI генерация ЗАПРЕЩЕНА для СРГ, не рекомендуется для Сертификатов │
│                                                                         │
│ 2️⃣ Паспорта качества — ГЕНЕРАЦИЯ ПРИОРИТЕТНА                          │
│    • Если есть Сертификат → генерируем Паспорт из него                 │
│    • Если НЕТ Сертификата → генерация ЗАПРЕЩЕНА                        │
│    • Помечаем: "Сгенерировано на основе Сертификата №..."              │
│    • Уверенность: 80-90% (требует проверки)                            │
│                                                                         │
│ 3️⃣ Технические паспорты — сайты производителей                        │
│    • Искать на официальных сайтах                                      │
│    • Google как альтернатива                                           │
│    • AI генерация возможна (типовой из ГОСТа)                          │
│                                                                         │
│ 4️⃣ Прозрачность для пользователя                                       │
│    • Каждый документ помечен источником                                │
│    • Для сгенерированных — ссылка на исходный Сертификат               │
│    • Уровень уверенности отображается                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```
