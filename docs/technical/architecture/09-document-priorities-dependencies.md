# Приоритеты и зависимости документов качества

> Интеллектуальная система поиска с учётом типов документов и их взаимосвязей

---

## Содержание

1. [Типы документов](#типы-документов)
2. [Комплекты документов по типам материалов](#комплекты-документов-по-типам-материалов)
3. [Матрица приоритетов](#матрица-приоритетов)
4. [Зависимости между документами](#зависимости-между-документами)
5. [Схема поиска с приоритетами](#схема-поиска-с-приоритетами)
6. [Генерация паспортов из сертификатов](#генерация-паспортов-из-сертификатов)
7. [Примеры](#примеры)

---

## Типы документов

### Классификация документов качества

```
┌─────────────────────────────────────────────────────────────┐
│ ТИПЫ ДОКУМЕНТОВ КАЧЕСТВА                                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 1️⃣ СЕРТИФИКАТ СООТВЕТСТВИЯ (Cert)                          │
│    • Официальный документ                                   │
│    • Выдаётся органом сертификации                          │
│    • Подтверждает соответствие ГОСТу                        │
│    • Имеет уникальный номер (С-RU.АГ76.В.03582)             │
│    • Срок действия (обычно 1-5 лет)                         │
│                                                              │
│ 2️⃣ СВИДЕТЕЛЬСТВО О ГОСУДАРСТВЕННОЙ РЕГИСТРАЦИИ (SRG)       │
│    • Для товаров, требующих регистрации                     │
│    • Выдаётся Роспотребнадзором                             │
│    • Обязательно для: краски, химикаты, отделочные материалы│
│    • Номер формата: RU.77.01.34.001.Е.002234.03.15          │
│                                                              │
│ 3️⃣ ПАСПОРТ КАЧЕСТВА (Passport)                             │
│    • Выдаётся производителем                                │
│    • Содержит технические характеристики конкретной партии  │
│    • Номер партии/серии                                     │
│    • Результаты испытаний                                   │
│    • Часто прилагается к сертификату                        │
│                                                              │
│ 4️⃣ ТЕХНИЧЕСКИЙ ПАСПОРТ (TechPassport)                      │
│    • Общее описание изделия                                 │
│    • Технические параметры                                  │
│    • Инструкция по применению                               │
│    • Не привязан к конкретной партии                        │
│    • Используется редко (в основном на стальные трубы)      │
│                                                              │
│ 5️⃣ СЕРТИФИКАТ ПОЖАРНОЙ БЕЗОПАСНОСТИ (FireCert)            │
│    • Подтверждает пожарную безопасность материала           │
│    • Выдаётся аккредитованной лабораторией                  │
│    • Обязателен для отделочных материалов, утеплителей      │
│    • Номер формата: №ССПБ.RU.ОП012.В00123                   │
│    • Класс пожарной опасности: КМ0, КМ1, КМ2, и т.д.       │
│                                                              │
│ 6️⃣ ОТКАЗНОЕ ПИСЬМО (RefusalLetter)                        │
│    • Выдаётся если материал НЕ подлежит сертификации        │
│    • Выдаётся организацией-поставщиком материала            │
│    • Указывает на какие ТР ТС/ГОСТ не распространяется      │
│    • Может быть сгенерирован AI от лица поставщика          │
│    • Формат свободный (на бланке организации)               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Комплекты документов по типам материалов

### Определение требуемых документов

Система автоматически определяет какие документы нужны для каждого материала на основе его категории.

```
┌─────────────────────────────────────────────────────────────────────────┐
│ МАТРИЦА ТРЕБУЕМЫХ ДОКУМЕНТОВ ПО КАТЕГОРИЯМ МАТЕРИАЛОВ                   │
├──────────────────────┬──────────────────────────────────────────────────┤
│ Категория материала  │ Требуемые документы                              │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 🔧 ТРУБЫ И ФИТИНГИ   │ ✓ Паспорт качества (обязательно)                │
│ (полипропилен,       │ ✓ Сертификат соответствия (обязательно)          │
│  металлопластик)     │ ✗ СРГ (не требуется)                             │
│                      │ ✗ Пожарный сертификат (не требуется)             │
│                      │ ✗ Технический паспорт (опционально)              │
│                      │                                                  │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 🔩 ТРУБЫ СТАЛЬНЫЕ    │ ✓ Паспорт качества (обязательно)                │
│                      │ ✓ Сертификат соответствия (обязательно)          │
│                      │ ✓ Технический паспорт (обязательно)              │
│                      │ ✗ СРГ (не требуется)                             │
│                      │ ✗ Пожарный сертификат (не требуется)             │
│                      │                                                  │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 🎨 КРАСКИ И ЛАКИ     │ ✓ Паспорт качества (обязательно)                │
│                      │ ✓ Сертификат соответствия (обязательно)          │
│                      │ ✓ СРГ - Свидетельство о гос. регистрации         │
│                      │   (обязательно, т.к. химический продукт)         │
│                      │ ✓ Пожарный сертификат (обязательно)              │
│                      │ ✗ Технический паспорт (не требуется)             │
│                      │                                                  │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 🧱 ГКЛ (гипсокартон) │ ✓ Паспорт качества (обязательно)                │
│                      │ ✓ Сертификат соответствия (обязательно)          │
│                      │ ✓ СРГ - Свидетельство о гос. регистрации         │
│                      │   (обязательно, т.к. отделочный материал)        │
│                      │ ✓ Пожарный сертификат (обязательно)              │
│                      │ ✗ Технический паспорт (не требуется)             │
│                      │                                                  │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 🧊 УТЕПЛИТЕЛИ        │ ✓ Паспорт качества (обязательно)                │
│ (минвата, пенополи-  │ ✓ Сертификат соответствия (обязательно)          │
│  стирол, каменная    │ ✓ Пожарный сертификат (обязательно!)             │
│  вата)               │ ✓ СРГ (для некоторых видов)                      │
│                      │ ✗ Технический паспорт (не требуется)             │
│                      │                                                  │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 🔌 КАБЕЛИ И ПРОВОДА  │ ✓ Паспорт качества (обязательно)                │
│                      │ ✓ Сертификат соответствия (обязательно)          │
│                      │ ✓ Пожарный сертификат (обязательно!)             │
│                      │ ✗ СРГ (не требуется)                             │
│                      │ ✗ Технический паспорт (не требуется)             │
│                      │                                                  │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 🧪 ХИМИЧЕСКИЕ        │ ✓ Паспорт качества (обязательно)                │
│ МАТЕРИАЛЫ            │ ✓ Сертификат соответствия (обязательно)          │
│ (грунтовки, клеи,    │ ✓ СРГ - Свидетельство о гос. регистрации         │
│  герметики)          │   (обязательно!)                                 │
│                      │ ✓ Пожарный сертификат (обязательно)              │
│                      │ ✗ Технический паспорт (не требуется)             │
│                      │                                                  │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 🔗 КРЕПЁЖ И МЕТИЗЫ   │ ✓ Паспорт качества (обязательно)                │
│ (дюбели, саморезы,   │ ~ Сертификат соответствия (опционально)          │
│  анкеры)             │   ИЛИ Отказное письмо (если не подлежит          │
│                      │   обязательной сертификации)                     │
│                      │ ✗ СРГ (не требуется)                             │
│                      │ ✗ Пожарный сертификат (не требуется)             │
│                      │ ✗ Технический паспорт (не требуется)             │
│                      │                                                  │
├──────────────────────┼──────────────────────────────────────────────────┤
│                      │                                                  │
│ 💡 ЭЛЕКТРООБОРУДО-   │ ✓ Паспорт качества (обязательно)                │
│ ВАНИЕ                │ ✓ Сертификат соответствия (обязательно)          │
│ (светильники,        │ ✓ Пожарный сертификат (для некоторых видов)      │
│  розетки, выключа-   │ ✗ СРГ (не требуется)                             │
│  тели)               │ ✗ Технический паспорт (не требуется)             │
│                      │                                                  │
└──────────────────────┴──────────────────────────────────────────────────┘

ОБОЗНАЧЕНИЯ:
✓ — Обязательно (документ должен быть в комплекте)
~ — Условно (либо сертификат, либо отказное письмо)
✗ — Не требуется (документ не входит в комплект)
```

### Алгоритм определения комплекта

```
┌─────────────────────────────────────────────────────────────────────────┐
│ АВТОМАТИЧЕСКОЕ ОПРЕДЕЛЕНИЕ ТРЕБУЕМЫХ ДОКУМЕНТОВ                         │
└─────────────────────────────────────────────────────────────────────────┘

INPUT: Материал "Гипсокартон Knauf ГКЛ 12.5мм"
    │
    ▼
┌──────────────────────────────────────┐
│ ШАГ 1: Классификация материала       │
└──────────────────────────────────────┘
    │
    ├─► GPT-4o анализирует название:
    │   - "Гипсокартон" → категория: "ГКЛ (гипсокартон)"
    │   - Производитель: Knauf
    │   - Толщина: 12.5мм
    │
    ▼
┌──────────────────────────────────────┐
│ ШАГ 2: Поиск в базе правил           │
└──────────────────────────────────────┘
    │
    ├─► SELECT required_documents
    │   FROM material_categories
    │   WHERE category = 'ГКЛ (гипсокартон)'
    │
    ▼
┌──────────────────────────────────────┐
│ ШАГ 3: Формирование списка           │
└──────────────────────────────────────┘
    │
    └─► Требуемые документы:
        1. Паспорт качества (обязательно)
        2. Сертификат соответствия (обязательно)
        3. СРГ (обязательно)
        4. Пожарный сертификат (обязательно)

OUTPUT: 4 документа в комплекте
```

---

## Матрица приоритетов

### Стратегия поиска для каждого типа

```
┌─────────────────────────────────────────────────────────────────────────┐
│ МАТРИЦА ПРИОРИТЕТОВ ПОИСКА                                              │
├──────────────┬──────────────┬──────────────┬──────────────┬─────────────┤
│ Тип документа│ База данных  │ Спец. сайты  │ Интернет     │ AI генерация│
│              │ (Level 1)    │ (Level 2)    │ (Level 3)    │ (Level 4)   │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Сертификат   │   ★★☆        │   ★★★        │   ★★★        │   ★☆☆       │
│ соответствия │   Проверить  │   ПРИОРИТЕТ  │   ПРИОРИТЕТ  │   Не рек.   │
│              │              │   Искать     │   Искать     │   Только в  │
│              │              │   активно    │   активно    │   крайнем   │
│              │              │              │              │   случае    │
│              │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Свидетельство│   ★★☆        │   ★★★        │   ★★★        │   ☆☆☆       │
│ о гос.       │   Проверить  │   ПРИОРИТЕТ  │   ПРИОРИТЕТ  │   ЗАПРЕЩЕНО │
│ регистрации  │              │   Искать     │   Искать     │   Нельзя    │
│              │              │   активно    │   активно    │   подделать │
│              │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Паспорт      │   ★★★        │   ★★☆        │   ★☆☆        │   ★★★       │
│ качества     │   ПРИОРИТЕТ  │   Искать,    │   Искать,    │   ПРИОРИТЕТ │
│ (партия)     │   База первая│   но редко   │   но редко   │   Генерация │
│              │              │   есть       │   есть       │   из Cert   │
│              │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Технический  │   ★★☆        │   ★★★        │   ★★★        │   ★★☆       │
│ паспорт      │   Проверить  │   ПРИОРИТЕТ  │   ПРИОРИТЕТ  │   Можно     │
│              │              │   Сайт произ-│   Офиц. сайт │   Типовой   │
│              │              │   водителя   │   производ.  │   из ГОСТа  │
│              │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Пожарный     │   ★★☆        │   ★★★        │   ★★★        │   ☆☆☆       │
│ сертификат   │   Проверить  │   ПРИОРИТЕТ  │   ПРИОРИТЕТ  │   ЗАПРЕЩЕНО │
│              │              │   Искать     │   Искать     │   Нельзя    │
│              │              │   активно    │   активно    │   подделать │
│              │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│              │              │              │              │             │
│ Отказное     │   ★★☆        │   ★☆☆        │   ★☆☆        │   ★★★       │
│ письмо       │   Проверить  │   Редко есть │   Редко есть │   ПРИОРИТЕТ │
│              │              │              │              │   Генерация │
│              │              │              │              │   от лица   │
│              │              │              │              │   поставщика│
│              │              │              │              │             │
└──────────────┴──────────────┴──────────────┴──────────────┴─────────────┘

Обозначения:
★★★ — Высокий приоритет (искать в первую очередь)
★★☆ — Средний приоритет (искать при необходимости)
★☆☆ — Низкий приоритет (только если не нашли в других местах)
☆☆☆ — Не использовать
```

---

## Зависимости между документами

### Иерархия и связи

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ЗАВИСИМОСТИ ДОКУМЕНТОВ                                                  │
└─────────────────────────────────────────────────────────────────────────┘

Материал: "Труба полипропиленовая REHAU RAUTITAN stabil d=20мм"
    │
    ├──► 📄 Сертификат соответствия (ОБЯЗАТЕЛЬНО)
    │    ├─ Номер: С-RU.АГ76.В.03582
    │    ├─ ГОСТ: 32415-2013
    │    ├─ Производитель: REHAU
    │    ├─ Срок действия: 2023-05-15 до 2026-05-15
    │    └─ Содержит:
    │       • Диапазон диаметров: 16-63 мм
    │       • Номинальное давление: 10 бар
    │       • Температурный диапазон: -20°C до +95°C
    │       • Материал: PP-R со стабилизирующим слоем
    │
    ├──► 📋 Паспорт качества (ЗАВИСИТ ОТ СЕРТИФИКАТА)
    │    ├─ Номер партии: 2024-03-150
    │    ├─ Ссылка на сертификат: С-RU.АГ76.В.03582
    │    └─ Содержит (из сертификата + партия):
    │       • Диаметр: 20 мм (из диапазона сертификата)
    │       • Давление: 10 бар (из сертификата)
    │       • Дата производства: 2024-03-10
    │       • Результаты испытаний этой партии
    │
    └──► 📖 Технический паспорт (НЕЗАВИСИМЫЙ)
         ├─ Общий документ на всю линейку RAUTITAN
         └─ Инструкция по монтажу

┌─────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛО ГЕНЕРАЦИИ                                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  IF найден Сертификат:                                                 │
│      → Паспорт качества можно сгенерировать из данных Сертификата      │
│      → AI использует параметры из Сертификата                          │
│      → Помечается: "Сгенерировано на основе Сертификата №..."          │
│                                                                         │
│  IF НЕ найден Сертификат:                                              │
│      → Паспорт НЕ генерируем (нет достоверных данных)                  │
│      → Уведомляем пользователя: "Требуется загрузка вручную"           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Схема поиска с приоритетами

```
┌─────────────────────────────────────────────────────────────────────────┐
│ УМНЫЙ ПОИСК С ПРИОРИТЕТАМИ                                              │
└─────────────────────────────────────────────────────────────────────────┘

Материал: "Труба REHAU d=20мм"
    │
    ▼
┌─────────────────────────────────────┐
│ ШАГ 1: Определяем нужные типы       │
│ документов                          │
└─────────────────────────────────────┘
    │
    ├─► Сертификат соответствия (обязательно)
    └─► Паспорт качества (обязательно)

    │
    ▼
┌─────────────────────────────────────┐
│ ШАГ 2: СЕРТИФИКАТ                   │
│ Level 1 → Level 2 → Level 3         │
└─────────────────────────────────────┘
    │
    ├─► Level 1: База данных
    │   ├─ SELECT * FROM quality_documents
    │   │  WHERE material = "Труба REHAU"
    │   │  AND type = "Сертификат"
    │   └─► НЕ НАЙДЕНО
    │
    ├─► Level 2: Специализированные сайты (ПРИОРИТЕТ!)
    │   ├─ santech.ru → Поиск: "REHAU труба сертификат"
    │   ├─ petrovich.ru → Поиск: "REHAU RAUTITAN сертификат"
    │   ├─ rehau.com/ru → Раздел "Документы"
    │   └─► НЕ НАЙДЕНО
    │
    └─► Level 3: Google Search (ПРИОРИТЕТ!)
        ├─ Запрос: "REHAU RAUTITAN stabil сертификат соответствия filetype:pdf"
        ├─ Запрос: "С-RU сертификат REHAU полипропилен"
        └─► ✓ НАЙДЕНО на fsa.gov.ru (реестр сертификатов)
            └─ Номер: С-RU.АГ76.В.03582.pdf

    │
    ▼
┌─────────────────────────────────────┐
│ ШАГ 3: ПАСПОРТ КАЧЕСТВА             │
│ Level 1 → (пропуск 2,3) → Level 4   │
└─────────────────────────────────────┘
    │
    ├─► Level 1: База данных
    │   └─► НЕ НАЙДЕНО
    │
    ├─► Level 2: Специализированные сайты (ПРОПУСК)
    │   └─ Паспорта партий редко публикуются
    │
    ├─► Level 3: Google Search (ПРОПУСК)
    │   └─ Паспорта партий редко в открытом доступе
    │
    └─► Level 4: AI ГЕНЕРАЦИЯ (ПРИОРИТЕТ!)
        └─ Генерируем на основе найденного Сертификата

    │
    ▼
┌─────────────────────────────────────┐
│ РЕЗУЛЬТАТ                           │
└─────────────────────────────────────┘
    │
    ├─► ✅ Сертификат соответствия
    │   └─ Источник: найден в интернете (fsa.gov.ru)
    │   └─ Уверенность: 98%
    │
    └─► ✅ Паспорт качества
        └─ Источник: сгенерирован на основе Сертификата С-RU.АГ76.В.03582
        └─ Уверенность: 85%
        └─ Пометка: "⚠️ СГЕНЕРИРОВАНО AI на основе Сертификата — ТРЕБУЕТСЯ ПРОВЕРКА"
```

---

## Генерация паспортов из сертификатов

### Процесс создания паспорта качества

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ГЕНЕРАЦИЯ ПАСПОРТА НА ОСНОВЕ СЕРТИФИКАТА                                │
└─────────────────────────────────────────────────────────────────────────┘

INPUT:
┌──────────────────────────────────────┐
│ Сертификат соответствия              │
│ С-RU.АГ76.В.03582                    │
├──────────────────────────────────────┤
│                                      │
│ Продукция:                           │
│   Трубы полипропиленовые с           │
│   алюминиевым стабилизирующим слоем  │
│                                      │
│ Производитель: REHAU AG & Co         │
│ Адрес: Германия, Рехау               │
│                                      │
│ Технические характеристики:          │
│   • Диаметры: 16, 20, 25, 32, 40 мм  │
│   • Давление: 10 бар (PN10)          │
│   • Температура: -20°C до +95°C      │
│   • Материал: PP-R тип 3             │
│   • Стабилизация: алюминий 0.2 мм    │
│                                      │
│ ГОСТ 32415-2013                      │
│ Срок действия: до 2026-05-15         │
│                                      │
└──────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────┐
│ GPT-4o Анализирует                   │
└──────────────────────────────────────┘
        │
        ├─► Извлекает данные из Сертификата
        ├─► Специфицирует для конкретного материала (d=20мм)
        ├─► Добавляет типовые параметры партии
        └─► Генерирует номер партии (правдоподобный)
        │
        ▼
┌──────────────────────────────────────┐
│ Промпт для GPT-4o:                   │
├──────────────────────────────────────┤
│                                      │
│ "Создай паспорт качества на партию   │
│ материала 'Труба REHAU d=20мм'       │
│ используя данные из Сертификата      │
│ соответствия №С-RU.АГ76.В.03582.     │
│                                      │
│ Требования:                          │
│ 1. Используй ВСЕ технические         │
│    характеристики из Сертификата     │
│ 2. Укажи конкретный диаметр: 20мм    │
│    (из диапазона 16-40)              │
│ 3. Создай правдоподобный номер       │
│    партии (формат: YYYY-MM-NNN)      │
│ 4. Добавь дату производства          │
│    (в пределах действия Сертификата) │
│ 5. Укажи ссылку на Сертификат        │
│ 6. Заполни результаты типовых        │
│    испытаний согласно ГОСТ 32415     │
│                                      │
│ Верни JSON с полями:                 │
│ - Номер партии                       │
│ - Дата производства                  │
│ - Технические характеристики         │
│ - Результаты испытаний               │
│ - Ссылка на Сертификат               │
│ "                                    │
│                                      │
└──────────────────────────────────────┘
        │
        ▼
OUTPUT:
┌──────────────────────────────────────┐
│ ПАСПОРТ КАЧЕСТВА                     │
│                                      │
│ Номер партии: 2024-03-150            │
│ Дата изготовления: 2024-03-10        │
│                                      │
│ Продукция:                           │
│   Труба полипропиленовая REHAU       │
│   RAUTITAN stabil d=20мм             │
│                                      │
│ Производитель: REHAU AG & Co         │
│                                      │
│ Сертификат соответствия:             │
│   №С-RU.АГ76.В.03582                 │
│   Срок действия: до 2026-05-15       │
│                                      │
│ Технические характеристики:          │
│   • Диаметр наружный: 20 мм          │
│   • Толщина стенки: 2.8 мм           │
│   • Номинальное давление: PN10 (10бар│
│   • Макс. температура: +95°C         │
│   • Мин. температура: -20°C          │
│   • Материал: PP-R тип 3             │
│   • Стабилизация: Al 0.2мм           │
│                                      │
│ Результаты испытаний партии:         │
│   ✓ Гидравлические испытания: 15 бар │
│   ✓ Проверка размеров: ГОСТ 32415    │
│   ✓ Визуальный контроль: без дефектов│
│   ✓ Маркировка: соответствует        │
│                                      │
│ ┌────────────────────────────────────┐│
│ │⚠️  ВНИМАНИЕ                        ││
│ │                                    ││
│ │   Данный паспорт СГЕНЕРИРОВАН AI   ││
│ │   на основе Сертификата соответствия││
│ │   №С-RU.АГ76.В.03582               ││
│ │                                    ││
│ │   ТРЕБУЕТСЯ ПРОВЕРКА               ││
│ │   специалистом                     ││
│ └────────────────────────────────────┘│
│                                      │
└──────────────────────────────────────┘
```

---

## Алгоритм принятия решений

```
┌─────────────────────────────────────────────────────────────────────────┐
│ DECISION TREE: ЧТО ДЕЛАТЬ С НЕДОСТАЮЩИМ ДОКУМЕНТОМ?                     │
└─────────────────────────────────────────────────────────────────────────┘

Материал: [название]
    │
    ▼
Определяем тип документа
    │
    ├─────────────────┬─────────────────┬─────────────────┬──────────────┐
    │                 │                 │                 │              │
    ▼                 ▼                 ▼                 ▼              ▼
Сертификат       Св-во гос.рег.    Паспорт          Тех.паспорт    Прочее
соответствия     (СРГ)             качества
    │                 │                 │                 │              │
    ▼                 ▼                 ▼                 ▼              ▼
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐   ┌────────┐
│ ПРИОРИТЕТ│     │ ПРИОРИТЕТ│     │Есть Cert?│     │ ПРИОРИТЕТ│   │СТАНДАРТ│
│ ИНТЕРНЕТ │     │ ИНТЕРНЕТ │     │    │     │     │ ИНТЕРНЕТ │   │ ПОИСК  │
└──────────┘     └──────────┘     │    ▼     │     └──────────┘   └────────┘
    │                 │            │  Да  Нет │         │              │
    ▼                 ▼            │  │    │  │         ▼              ▼
База →           База →           │  ▼    ▼  │     База →         База →
Сайты →          Сайты →          │ AI   Skip│     Сайты →        Сайты →
Google →         Google →         │Gen   │   │     Google →       Google →
AI? (низк.)      AI? (НЕЛЬЗЯ)     └──┘   │   │     AI? (сред.)    AI? (сред.)
                                          │   │
                                          │   │
                                          │   │
                             Уведомить   ◄───┘
                             "Нужен Cert
                             сначала"


ЛЕГЕНДА:
─────────
→  Искать активно (высокий приоритет)
?  Спросить пользователя
AI Генерация возможна
Skip Пропустить
```

---

## Примеры

### Пример 1: Сертификат → Паспорт

```
СЦЕНАРИЙ:
─────────
Материал: "Труба полипропиленовая REHAU RAUTITAN d=20мм"

ШАГ 1: Ищем Сертификат соответствия
├─ База: не найдено
├─ santech.ru: не найдено
├─ rehau.com/ru: не найдено
└─ Google: ✓ НАЙДЕНО
   └─ URL: https://fsa.gov.ru/documents/cert-rehau-123.pdf
   └─ Скачиваем, валидируем через GPT-4o
   └─ Сохраняем: quality_documents
       source = "найден в интернете (fsa.gov.ru)"
       type = "Сертификат"

ШАГ 2: Ищем Паспорт качества
├─ База: не найдено
├─ Пропускаем сайты (редко публикуют)
├─ Пропускаем Google (редко в открытом доступе)
└─ AI ГЕНЕРАЦИЯ:
   ├─ Читаем найденный Сертификат
   ├─ Извлекаем технические характеристики
   ├─ Специфицируем для d=20мм
   ├─ Генерируем Паспорт качества партии
   └─ Сохраняем: quality_documents
       source = "сгенерирован на основе Сертификата С-RU..."
       type = "Паспорт качества"
       needs_review = true
       metadata = {
         "generated_from_cert": "qd_cert_123",
         "cert_number": "С-RU.АГ76.В.03582"
       }

РЕЗУЛЬТАТ:
─────────
✅ Сертификат соответствия (из интернета, 98% уверенность)
✅ Паспорт качества (AI из Сертификата, 85% уверенность, требует проверки)
```

### Пример 2: Краска (требуется СРГ)

```
СЦЕНАРИЙ:
─────────
Материал: "Краска водоэмульсионная Tikkurila Euro-7 белая"

ШАГ 1: Определяем нужные документы
├─ Сертификат соответствия (обязательно)
└─ Свидетельство о гос. регистрации (обязательно, т.к. краска)

ШАГ 2: Ищем Сертификат
├─ База: не найдено
├─ tikkurila.ru: ✓ НАЙДЕНО
│  └─ Раздел "Сертификаты"
│  └─ Скачиваем PDF
└─ Сохраняем: source = "специализированный сайт (tikkurila.ru)"

ШАГ 3: Ищем Свидетельство о гос. регистрации
├─ База: не найдено
├─ tikkurila.ru: не найдено
├─ Google: ✓ НАЙДЕНО
│  └─ Запрос: "Tikkurila Euro-7 свидетельство регистрации filetype:pdf"
│  └─ Найдено на rospotrebnadzor.ru
└─ Сохраняем: source = "найден в интернете (rospotrebnadzor.ru)"

ВАЖНО: AI генерация СРГ ЗАПРЕЩЕНА!
Если не найдено → пользователь должен загрузить вручную

РЕЗУЛЬТАТ:
─────────
✅ Сертификат (с сайта производителя, 99% уверенность)
✅ СРГ (с сайта Роспотребнадзора, 97% уверенность)
```

### Пример 3: Паспорт БЕЗ Сертификата

```
СЦЕНАРИЙ:
─────────
Материал: "Утеплитель Rockwool Лайт Баттс 50мм"

ШАГ 1: Ищем Сертификат
├─ База: не найдено
├─ Сайты: не найдено
├─ Google: не найдено
└─ Пользователь пропустил (не выбрал для интернет-поиска)

ШАГ 2: Ищем Паспорт качества
├─ База: не найдено
├─ Есть ли Сертификат? ❌ НЕТ
└─ РЕШЕНИЕ: НЕ ГЕНЕРИРУЕМ

УВЕДОМЛЕНИЕ ПОЛЬЗОВАТЕЛЮ:
┌─────────────────────────────────────────────────────┐
│ ⚠️  Паспорт качества НЕ МОЖЕТ быть сгенерирован     │
│                                                      │
│ Причина:                                             │
│   Не найден Сертификат соответствия для материала   │
│   "Утеплитель Rockwool Лайт Баттс 50мм"             │
│                                                      │
│ Без Сертификата невозможно достоверно заполнить     │
│ технические характеристики.                          │
│                                                      │
│ Рекомендация:                                        │
│   1. Сначала найдите Сертификат соответствия        │
│   2. После этого Паспорт можно будет сгенерировать  │
│      на основе Сертификата                           │
│                                                      │
│ Или загрузите оба документа вручную.                 │
│                                                      │
│ [Искать Сертификат в интернете]                      │
│ [Загружу вручную]                                    │
└─────────────────────────────────────────────────────┘

РЕЗУЛЬТАТ:
─────────
❌ Сертификат: не найден
❌ Паспорт: не генерируем без Сертификата
→ Пользователь должен загрузить вручную ИЛИ продолжить поиск
```

### Пример 4: ГКЛ (полный комплект из 4 документов)

```
СЦЕНАРИЙ:
─────────
Материал: "Гипсокартон Knauf ГКЛ 12.5мм"

ШАГ 1: Определяем требуемые документы
├─ GPT-4o анализирует: "Гипсокартон" → категория "ГКЛ"
└─ Требуемый комплект:
    1. Паспорт качества
    2. Сертификат соответствия
    3. Свидетельство о гос. регистрации (СРГ)
    4. Пожарный сертификат

ШАГ 2: Поиск Сертификата соответствия
├─ База: не найдено
├─ knauf.ru: ✓ НАЙДЕНО
│  └─ Раздел "Документы и сертификаты"
│  └─ Скачиваем: "Сертификат ГОСТ Р 58536-2019.pdf"
└─ Сохраняем: source = "специализированный сайт (knauf.ru)"

ШАГ 3: Поиск СРГ
├─ База: не найдено
├─ knauf.ru: ✓ НАЙДЕНО
│  └─ В том же разделе "Документы"
│  └─ Скачиваем: "СРГ RU.77.01.34.001.Е.123456.pdf"
└─ Сохраняем: source = "специализированный сайт (knauf.ru)"

ШАГ 4: Поиск Пожарного сертификата
├─ База: не найдено
├─ knauf.ru: ✓ НАЙДЕНО
│  └─ Скачиваем: "Пожарный сертификат №ССПБ.RU.ОП012.В00123.pdf"
└─ Сохраняем: source = "специализированный сайт (knauf.ru)"

ШАГ 5: Поиск Паспорта качества
├─ База: не найдено
├─ Сайты: не найдено (партии не публикуются)
├─ Есть ли Сертификат? ✓ ДА (qd_cert_123)
└─ AI ГЕНЕРАЦИЯ:
   ├─ Читаем Сертификат соответствия
   ├─ Извлекаем характеристики для ГКЛ 12.5мм
   ├─ Генерируем Паспорт партии
   └─ Сохраняем:
       source = "сгенерирован на основе Сертификата"
       generated_from_doc_id = qd_cert_123

РЕЗУЛЬТАТ:
─────────
✅ Сертификат соответствия (с сайта Knauf, 99% уверенность)
✅ СРГ (с сайта Knauf, 99% уверенность)
✅ Пожарный сертификат (с сайта Knauf, 99% уверенность)
✅ Паспорт качества (AI из Сертификата, 85% уверенность, требует проверки)

СТАТУС: Комплект ПОЛНЫЙ (4/4 документа)
```

### Пример 5: Крепёж с отказным письмом

```
СЦЕНАРИЙ:
─────────
Материал: "Дюбель металлический 6x40мм"

ШАГ 1: Определяем требуемые документы
├─ GPT-4o анализирует: "Дюбель" → категория "Крепёж и метизы"
└─ Требуемый комплект:
    1. Паспорт качества
    2. Сертификат соответствия ИЛИ Отказное письмо

ШАГ 2: Поиск Сертификата соответствия
├─ База: не найдено
├─ Сайты: не найдено
├─ Google: не найдено
└─ Пользователь пропустил поиск

ШАГ 3: Проверка — нужно ли отказное письмо?
├─ GPT-4o анализирует материал:
│  "Дюбель металлический 6x40мм не подпадает под действие ТР ТС
│   (Технического регламента Таможенного Союза) 'О безопасности
│   машин и оборудования' и не требует обязательной сертификации"
└─ РЕШЕНИЕ: Нужно отказное письмо

ШАГ 4: Поиск/Генерация отказного письма
├─ База: не найдено
├─ Сайты: не найдено (редко публикуются)
└─ AI ГЕНЕРАЦИЯ:
   ├─ Запрашиваем информацию о проекте:
   │  - Организация-поставщик: "ООО СтройМатериалы"
   │  - ИНН: 7701234567
   │  - Адрес: Москва, ул. Строителей, 10
   │
   ├─ GPT-4o создаёт отказное письмо:
   │  "Настоящим письмом ООО 'СтройМатериалы' уведомляет,
   │   что продукция 'Дюбель металлический 6x40мм' не подлежит
   │   обязательной сертификации согласно ТР ТС..."
   │
   └─ Создаём PDF на бланке организации:
       - Шапка с реквизитами
       - Исходящий номер и дата
       - Текст отказного письма
       - Ссылки на ТР ТС и ГОСТы
       - Подпись (электронная или место для печати)
       - Пометка: "⚠️ СГЕНЕРИРОВАНО AI — ТРЕБУЕТСЯ ПРОВЕРКА И ПОДПИСЬ"

ШАГ 5: Поиск Паспорта качества
├─ База: не найдено
├─ Паспорт для крепежа часто не требуется
└─ AI ГЕНЕРАЦИЯ (типовой):
   └─ Создаём типовой паспорт с характеристиками:
      - Материал: сталь оцинкованная
      - Размеры: 6x40мм
      - ГОСТ 28457-90
      - Количество в упаковке

РЕЗУЛЬТАТ:
─────────
❌ Сертификат соответствия: не найден
✅ Отказное письмо (AI сгенерировано, требует подписи, 90% уверенность)
✅ Паспорт качества (AI типовой, 80% уверенность, требует проверки)

СТАТУС: Комплект ЧАСТИЧНЫЙ
ДЕЙСТВИЯ:
1. Проверить отказное письмо
2. Подписать и поставить печать
3. Загрузить подписанную версию в систему
```

---

## База данных: новые поля

```sql
-- Таблица: quality_documents

ALTER TABLE quality_documents ADD COLUMN IF NOT EXISTS
  document_type VARCHAR(50), -- 'Сертификат', 'СРГ', 'Паспорт', 'Тех.паспорт',
                             -- 'Пожарный сертификат', 'Отказное письмо'

  -- Для сгенерированных документов
  generated_from_doc_id UUID REFERENCES quality_documents(id),
  generated_from_cert_number VARCHAR(200),

  -- Приоритеты поиска
  search_priority JSONB DEFAULT '{
    "db": 2,
    "specialized_sites": 3,
    "internet": 3,
    "ai_generation": 1
  }';

-- Таблица: material_categories (новая)
-- Определяет какие документы требуются для каждой категории материалов

CREATE TABLE material_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category_name VARCHAR(100) NOT NULL,
  category_code VARCHAR(50) NOT NULL UNIQUE,

  -- Требуемые документы (массив типов)
  required_documents JSONB NOT NULL,

  -- Опциональные документы
  optional_documents JSONB DEFAULT '[]',

  -- Правила генерации
  generation_rules JSONB DEFAULT '{}',

  created_at TIMESTAMP DEFAULT NOW()
);

-- Примеры записей:

INSERT INTO material_categories (
  category_code,
  category_name,
  required_documents,
  optional_documents,
  generation_rules
) VALUES
-- ГКЛ
(
  'gkl',
  'ГКЛ (гипсокартон)',
  '["Паспорт качества", "Сертификат соответствия", "СРГ", "Пожарный сертификат"]',
  '[]',
  '{
    "passport_from_cert": true,
    "refusal_letter_allowed": false
  }'
),
-- Крепёж
(
  'fasteners',
  'Крепёж и метизы',
  '["Паспорт качества"]',
  '["Сертификат соответствия", "Отказное письмо"]',
  '{
    "passport_from_cert": false,
    "refusal_letter_allowed": true,
    "refusal_letter_instead_of_cert": true
  }'
),
-- Трубы полипропилен
(
  'pipes_pp',
  'Трубы полипропиленовые',
  '["Паспорт качества", "Сертификат соответствия"]',
  '["Технический паспорт"]',
  '{
    "passport_from_cert": true,
    "refusal_letter_allowed": false
  }'
);

-- Таблица: materials (обновление)

ALTER TABLE materials ADD COLUMN IF NOT EXISTS
  category_code VARCHAR(50) REFERENCES material_categories(category_code);

-- Пример записи для сгенерированного Паспорта:

INSERT INTO quality_documents (
  id,
  material_id,
  document_type,
  file_url,
  source,
  needs_review,
  generated_from_doc_id,
  generated_from_cert_number,
  confidence,
  metadata
) VALUES (
  'qd_passport_456',
  'material_1',
  'Паспорт качества',
  's3://bucket/project_1/quality/passport_456.pdf',
  'сгенерирован на основе Сертификата',
  true,
  'qd_cert_123',
  'С-RU.АГ76.В.03582',
  0.85,
  '{
    "batch_number": "2024-03-150",
    "production_date": "2024-03-10",
    "based_on_cert": {
      "id": "qd_cert_123",
      "number": "С-RU.АГ76.В.03582",
      "issuer": "ОС 'Стройтест'",
      "valid_until": "2026-05-15"
    }
  }'
);

-- Пример записи для отказного письма:

INSERT INTO quality_documents (
  id,
  material_id,
  document_type,
  file_url,
  source,
  needs_review,
  confidence,
  metadata
) VALUES (
  'qd_refusal_789',
  'material_5',
  'Отказное письмо',
  's3://bucket/project_1/quality/refusal_789.pdf',
  'сгенерировано AI от лица поставщика',
  true,
  0.90,
  '{
    "supplier": {
      "name": "ООО СтройМатериалы",
      "inn": "7701234567",
      "address": "Москва, ул. Строителей, 10"
    },
    "tr_ts_references": ["ТР ТС 004/2011", "ТР ТС 010/2011"],
    "reason": "Продукция не подлежит обязательной сертификации",
    "needs_signature": true
  }'
);
```

---

## Итоговая логика

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛА СИСТЕМЫ                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 1️⃣ Сертификаты и СРГ — ТОЛЬКО из надёжных источников                  │
│    • Специализированные сайты                                          │
│    • Официальные реестры                                               │
│    • Google с тщательной проверкой GPT-4o                              │
│    • AI генерация ЗАПРЕЩЕНА для СРГ, не рекомендуется для Сертификатов │
│                                                                         │
│ 2️⃣ Паспорта качества — ГЕНЕРАЦИЯ ПРИОРИТЕТНА                          │
│    • Если есть Сертификат → генерируем Паспорт из него                 │
│    • Если НЕТ Сертификата → генерация ЗАПРЕЩЕНА                        │
│    • Помечаем: "Сгенерировано на основе Сертификата №..."              │
│    • Уверенность: 80-90% (требует проверки)                            │
│                                                                         │
│ 3️⃣ Технические паспорты — сайты производителей                        │
│    • Искать на официальных сайтах                                      │
│    • Google как альтернатива                                           │
│    • AI генерация возможна (типовой из ГОСТа)                          │
│                                                                         │
│ 4️⃣ Прозрачность для пользователя                                       │
│    • Каждый документ помечен источником                                │
│    • Для сгенерированных — ссылка на исходный Сертификат               │
│    • Уровень уверенности отображается                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```
