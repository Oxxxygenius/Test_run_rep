# –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-15
**–î–ª—è –∫–æ–≥–æ:** –î–ª—è QA –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

---

## üéØ –¶–µ–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ
2. **–ö–∞—á–µ—Å—Ç–≤–æ AI** ‚Äî –∞–≥–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –¥–∞–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SLA
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìä –ü–∏—Ä–∞–º–∏–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ    E2E     ‚îÇ  5% (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)
                  ‚îÇ   Tests    ‚îÇ
                ‚îå‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îê
                ‚îÇ  Integration   ‚îÇ  25% (API, Celery, DB)
                ‚îÇ     Tests      ‚îÇ
              ‚îå‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îê
              ‚îÇ    Unit Tests      ‚îÇ  70% (—Ñ—É–Ω–∫—Ü–∏–∏, –º–æ–¥—É–ª–∏)
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 1Ô∏è‚É£ Unit-—Ç–µ—Å—Ç—ã (pytest)

### –¶–µ–ª–µ–≤–æ–π coverage: 80%+ –æ–±—â–∏–π, 95%+ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–¥—É–ª–∏

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –£—Ç–∏–ª–∏—Ç—ã –∏ helper —Ñ—É–Ω–∫—Ü–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (Pydantic models)
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü–∞—Ä—Å–∏–Ω–≥ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–º–µ—Ä:**
```python
# tests/unit/test_utils.py
import pytest
from app.utils import physical_sheets_to_pdf_pages

def test_physical_sheets_conversion():
    assert physical_sheets_to_pdf_pages(1.0) == 2
    assert physical_sheets_to_pdf_pages(1.5) == 4  # –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö
    assert physical_sheets_to_pdf_pages(10.2) == 22

def test_aosr_number_generation():
    from app.utils import generate_aosr_number

    number = generate_aosr_number(project_id=123, sequence=5)
    assert number == "–ê–û–°–†-123-005"
```

**–ó–∞–ø—É—Å–∫:**
```bash
pytest tests/unit -v --cov=app --cov-report=html
```

---

## 2Ô∏è‚É£ Integration-—Ç–µ—Å—Ç—ã

### –¶–µ–ª–µ–≤–æ–π coverage: 90%+ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### 2.1. API Endpoints (FastAPI TestClient)

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –í—Å–µ REST API endpoints
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ö–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–º–µ—Ä:**
```python
# tests/integration/test_projects_api.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_create_project_success():
    response = client.post(
        "/api/v1/projects",
        headers={"Authorization": f"Bearer {get_test_token()}"},
        json={
            "name": "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç",
            "address": "–≥. –ú–æ—Å–∫–≤–∞",
            "package_format": "unified"
        }
    )
    assert response.status_code == 201
    data = response.json()
    assert data["success"] == True
    assert "id" in data["data"]
    assert data["data"]["name"] == "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"

def test_create_project_unauthorized():
    response = client.post("/api/v1/projects", json={})
    assert response.status_code == 401
```

---

### 2.2. Celery Tasks

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –ó–∞–ø—É—Å–∫ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```python
# tests/integration/test_celery_tasks.py
import pytest
from app.tasks import analyze_rd_task

@pytest.mark.celery
def test_analyze_rd_task_success(test_db, sample_document):
    """–¢–µ—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –†–î"""
    result = analyze_rd_task.apply(args=[sample_document.id]).get()

    assert result["success"] == True
    assert result["work_types_count"] > 0
    assert result["materials_count"] > 0

@pytest.mark.celery
def test_analyze_rd_task_retry_on_api_error(test_db, monkeypatch):
    """–¢–µ—Å—Ç retry –ø—Ä–∏ –æ—à–∏–±–∫–µ OpenAI API"""
    # Mock OpenAI API –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –æ—à–∏–±–∫–∏
    def mock_openai_error(*args, **kwargs):
        raise OpenAIError("Rate limit exceeded")

    monkeypatch.setattr("openai.ChatCompletion.create", mock_openai_error)

    with pytest.raises(Retry):
        analyze_rd_task.apply(args=[123])
```

---

### 2.3. Database Queries

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ò–Ω–¥–µ–∫—Å—ã –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- Constraints –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

**–ü—Ä–∏–º–µ—Ä:**
```python
# tests/integration/test_database.py
from app.models import Project, AOSR
from sqlalchemy.orm import Session

def test_project_cascade_delete(test_db: Session):
    """–¢–µ—Å—Ç –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞"""
    project = Project(name="Test", address="Test")
    test_db.add(project)
    test_db.commit()

    aosr = AOSR(project_id=project.id, work_type="Test")
    test_db.add(aosr)
    test_db.commit()

    test_db.delete(project)
    test_db.commit()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ê–û–°–† —Ç–æ–∂–µ —É–¥–∞–ª–∏–ª—Å—è
    assert test_db.query(AOSR).filter_by(id=aosr.id).first() is None
```

---

## 3Ô∏è‚É£ E2E —Ç–µ—Å—Ç—ã (Playwright)

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –ü–æ–ª–Ω—ã–π workflow –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –¥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–∫–µ—Ç–∞
- UI –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä:**
```python
# tests/e2e/test_full_workflow.py
from playwright.sync_api import Page, expect

def test_full_project_workflow(page: Page, logged_in_user):
    """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–µ–∫—Ç–æ–º"""

    # 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    page.goto("/projects/new")
    page.fill('input[name="name"]', "–¢–µ—Å—Ç–æ–≤—ã–π –ñ–ö")
    page.fill('input[name="address"]', "–≥. –ú–æ—Å–∫–≤–∞")
    page.click('button:text("–°–æ–∑–¥–∞—Ç—å")')
    expect(page).to_have_url("/projects/proj_*")

    # 2. –ó–∞–≥—Ä—É–∑–∫–∞ –†–î
    page.set_input_files('input[type="file"]', "test_data/rd_sample.pdf")
    expect(page.locator('text="–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω"')).to_be_visible()

    # 3. –ê–Ω–∞–ª–∏–∑ –†–î
    page.click('button:text("–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –†–î")')
    expect(page.locator('text="–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω"')).to_be_visible(timeout=120000)

    # 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ê–û–°–†
    page.click('button:text("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ê–û–°–†")')
    expect(page.locator('.aosr-item')).to_have_count(10)

    # 5. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
    page.click('button:text("–°–æ–∑–¥–∞—Ç—å –ø–∞–∫–µ—Ç –ò–î")')
    expect(page.locator('text="–ü–∞–∫–µ—Ç –≥–æ—Ç–æ–≤"')).to_be_visible(timeout=60000)

    # 6. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
    with page.expect_download() as download_info:
        page.click('button:text("–°–∫–∞—á–∞—Ç—å PDF")')
    download = download_info.value
    assert download.suggested_filename.endswith(".pdf")
```

---

## 4Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI-–∞–≥–µ–Ω—Ç–æ–≤

### Mock vs Real API

**Development:** Mock OpenAI API
```python
# conftest.py
@pytest.fixture
def mock_openai():
    with patch("openai.ChatCompletion.create") as mock:
        mock.return_value = {
            "choices": [{
                "message": {
                    "content": json.dumps({
                        "work_types": [...],
                        "materials": [...]
                    })
                }
            }]
        }
        yield mock
```

**Staging/Production:** Real API —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```python
@pytest.mark.slow
@pytest.mark.requires_openai
def test_real_openai_analysis():
    """–¢–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º OpenAI API"""
    result = analyze_rd_with_gpt(test_document)
    assert result["work_types"] is not None
```

---

## 5Ô∏è‚É£ Performance —Ç–µ—Å—Ç—ã (Locust)

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
- –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ API
- –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å

**–ü—Ä–∏–º–µ—Ä:**
```python
# tests/performance/locustfile.py
from locust import HttpUser, task, between

class PlatformUser(HttpUser):
    wait_time = between(1, 3)

    def on_start(self):
        """–õ–æ–≥–∏–Ω –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏"""
        response = self.client.post("/api/v1/auth/login", json={
            "email": "test@example.com",
            "password": "password"
        })
        self.token = response.json()["data"]["access_token"]

    @task(3)
    def get_projects(self):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤"""
        self.client.get(
            "/api/v1/projects",
            headers={"Authorization": f"Bearer {self.token}"}
        )

    @task(1)
    def create_project(self):
        """–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç"""
        self.client.post(
            "/api/v1/projects",
            headers={"Authorization": f"Bearer {self.token}"},
            json={"name": "Load Test", "address": "Test"}
        )
```

**–ó–∞–ø—É—Å–∫:**
```bash
locust -f tests/performance/locustfile.py --host=https://api.pto-platform.ru
```

---

## 6Ô∏è‚É£ Security —Ç–µ—Å—Ç—ã

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- SQL Injection
- XSS –∞—Ç–∞–∫–∏
- CSRF protection
- Rate limiting
- JWT security

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- OWASP ZAP
- Bandit (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑)
- Safety (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)

**–ü—Ä–∏–º–µ—Ä:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
safety check

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
bandit -r app/ -ll

# OWASP ZAP scan
zap-cli quick-scan https://api.pto-platform.ru
```

---

## üìã Coverage targets

| –ú–æ–¥—É–ª—å | Target Coverage |
|--------|----------------|
| **API routes** | 95%+ |
| **AI agents** | 90%+ |
| **Database models** | 95%+ |
| **Celery tasks** | 90%+ |
| **Utils/helpers** | 85%+ |
| **Frontend components** | 70%+ |

---

## üöÄ CI/CD Pipeline

```yaml
# .github/workflows/tests.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt -r requirements-dev.txt

      - name: Run unit tests
        run: pytest tests/unit -v --cov=app --cov-report=xml

      - name: Run integration tests
        run: pytest tests/integration -v
        env:
          DATABASE_URL: postgresql://test:test@localhost/test_db
          REDIS_URL: redis://localhost:6379/0

      - name: Upload coverage
        uses: codecov/codecov-action@v2
        with:
          files: ./coverage.xml

      - name: Security scan
        run: |
          bandit -r app/ -ll
          safety check
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è merge –≤ main:**
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ Coverage ‚â• 80%
- ‚úÖ –ù–µ—Ç critical security issues
- ‚úÖ –ö–æ–¥ –ø—Ä–æ—à–µ–ª –ª–∏–Ω—Ç–µ—Ä (black, flake8)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-15
